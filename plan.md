# プロジェクト全体の包括的実行・監視プロンプト（mainワークフロー検証用）

あなたは高性能なシステム解析AIエージェントです。  
以下のプロンプトは、**main.py全体のワークフローを自律的に実行・評価・監視**し、  
処理結果と出力物を包括的にレビューするためのものです。  
言語品質の劣化を許可しません。論理的・構造的・再現可能な分析を行ってください。

---

## 🎯 目的

本プロジェクトの `main.py` に実装された **フェーズ1〜5およびオプション評価フェーズ** を、  
実際に実行し、**出力の整合性・品質・再現性・パフォーマンス**を検証する。  
その結果をもとに、プロジェクト全体の健全性を俯瞰的にモニタリングし、改善提案を提示する。

---

## 🧩 対象フェーズと確認項目

### フェーズ1：フレームサンプリング
- 設定 (`config.yaml`) に基づき、5分間隔のフレームが正確に抽出されているか。
- OCRによるタイムスタンプ抽出が行われ、正規化されているか。
- 出力: `sample_frames`, `frames_ocr.csv`  
- チェック: フレーム数、時刻整合性、OCR認識率、異常フレームログ。

### フェーズ2：ViT人物検出
- モデルロード正常化、デバイス選択（MPS/CUDA/CPU）確認。
- 各フレームで人物検出が正しく動作しているか。
- 出力: `detection_results`, 検出可視化画像。  
- チェック: 検出人数の妥当性、confidence分布、処理速度。

### フェーズ3：座標変換とゾーン判定
- ホモグラフィ行列による座標変換が正しいか（座標の整合性検証）。
- 各人物が適切なゾーンに分類されているか（境界付近の判定も含む）。
- 出力: `frame_results`。  
- チェック: フロアマップ上のプロット整合性、ゾーン境界誤分類率。

### フェーズ4：集計・レポート生成
- フレーム単位→ゾーン単位への集計が正確か。
- CSV (`zone_counts.csv`) の形式、列構造、時系列整合性。
- チェック: 人数の合計一致、欠損行、NaN値の有無、統計値妥当性。

### フェーズ5：可視化
- グラフ出力（人数推移、ゾーン別統計、ヒートマップ）を確認。
- 出力先: `output/graphs/`, `output/floormaps/`。  
- チェック: ファイル数、生成時刻、画像の内容（軸ラベル・凡例・整合性）。

### オプション：精度評価
- `--evaluate` 実行時、Ground Truthとの一致率を確認。
- Precision / Recall / F1 スコアを算出。
- 評価レポート出力の整合性を検証。

---

## 🧠 実行・評価タスク

1. **実行確認**
   - `main.py` を全工程実行。全フェーズのログを収集。
   - 実行時間、メモリ使用量、各フェーズの処理件数を記録。

2. **出力整合性検証**
   - すべての出力ディレクトリを走査。
   - 生成ファイルの存在・拡張子・ファイルサイズ・更新時刻を記録。
   - 各フェーズの出力が次フェーズの入力に正しく参照されているかを検証。

3. **品質・性能メトリクス算出**
   - 各フェーズの成功率、エラー件数、平均処理時間。
   - OCR精度、人物検出confidence平均、ゾーン判定精度。
   - 集計CSVと可視化出力の整合性。

4. **包括レポート生成**
   - Markdown形式で `output/diagnostics/main_workflow_report.md` を生成。
   - 以下の内容を含める：
     - 処理フロー概要図（フェーズ間の依存関係）
     - 各フェーズの成功率・主要指標・異常検出結果
     - 出力ディレクトリ構造ツリーとファイル数
     - 検出された問題と改善提案（優先度付き）
     - 実行時間分布・CPU/GPU使用率（可能な場合）
     - 総合評価スコア（精度・再現性・安定性・パフォーマンス）

5. **改善提案**
   - ボトルネック特定と修正案を提示（コード差分・パラメータ調整含む）。
   - 改善の効果を定量的に予測。

---

## 📊 出力仕様

| 出力物 | 内容 | 格納先 |
|--------|------|--------|
| `main_workflow_report.md` | 各フェーズの評価・改善提案レポート | `output/diagnostics/` |
| `workflow_summary.json` | 各フェーズの成功率・処理時間メトリクス | `output/diagnostics/metrics/` |
| `failed_frames/` | 処理失敗フレームとOCR出力例 | `output/diagnostics/` |
| `file_tree.txt` | 出力ファイル構造一覧 | `output/diagnostics/` |

---

## ✅ 成功判定条件

- 全フェーズが例外なく完了（ログに致命的エラーなし）。
- OCR認識率 ≥ 85%、人物検出成功率 ≥ 95%、ゾーン判定整合率 ≥ 90%。
- 集計CSVと可視化出力が一致（時刻・ゾーン数・件数）。
- `main_workflow_report.md` がすべての評価結果を含み、再実行可能な状態。

---

## ⚙️ 出力フォーマット例（サマリ）

```markdown
# mainワークフロー総合評価レポート

## 全体概要
- 実行日時: 2025-11-05 14:12:00
- 総フェーズ: 5 (+評価オプション)
- 実行時間: 00:18:32
- 致命的エラー: 0
- 総合成功率: 96%

## フェーズ別指標
| フェーズ | 成功率 | 主な問題 | 改善案 |
|----------|--------|----------|--------|
| フェーズ1 | 88% | OCR誤認（スラッシュ欠落） | CLAHE+反転 |
| フェーズ2 | 97% | 特定角度で人物検出漏れ | ViT閾値調整 |
| フェーズ3 | 95% | 境界ゾーン誤分類 | ポリゴン補正 |
| フェーズ4 | 100% | - | - |
| フェーズ5 | 100% | 軸ラベル欠落 | Matplotlib設定修正 |

## 出力ディレクトリ構成

output/
├── detections/
├── floormaps/
├── graphs/
├── diagnostics/
│   ├── main_workflow_report.md
│   └── metrics/
│       └── workflow_summary.json




⸻

🚀 実行ポリシー
	•	フェーズ間のデータ依存を明確に追跡すること。
	•	出力内容を破壊せず、コピーで検証すること。
	•	解析ログはすべて保存し、結果再現可能であること。
	•	文体・表現品質を落とさず、論理的で構造的に報告すること。

⸻

以上の指示を厳密に実行し、
main.py 全フェーズの完全実行ログと包括レポートを生成・評価してください。

