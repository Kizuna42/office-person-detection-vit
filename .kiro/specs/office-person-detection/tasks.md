# 実装タスクリスト

- [x] 1. プロジェクト構造とデータモデルの実装

  - プロジェクトディレクトリ構造を作成（src/, input/, data/, output/, tests/）
  - データクラス（Detection, FrameResult, AggregationResult, EvaluationMetrics）を実装
  - Detection クラスに floor_coords_mm フィールドを追加（mm 単位の座標）
  - requirements.txt を作成し、必要な依存関係を定義
  - _要件: 1.1, 2.4, 4.7, 8.2_

- [x] 2. 設定管理モジュールの実装

  - ConfigManager クラスを実装（YAML/JSON 読み込み、検証、取得メソッド）
  - デフォルト設定ファイル（config.yaml）のテンプレートを作成
  - フロアマップ固定パラメータセクションを追加（image_width: 1878, image_height: 1369, origin: (7, 9), scale: 28.19/28.24 mm/pixel）
  - 設定値の妥当性検証ロジックを実装（必須項目チェック、型チェック、フロアマップパラメータ検証）
  - _要件: 4.2, 4.9, 8.1, 8.2, 8.3, 8.4_

- [x] 3. 動画処理とフレームサンプリングの実装
- [x] 3.1 VideoProcessor クラスを実装

  - 動画ファイルの読み込み、フレーム取得、リソース解放メソッドを実装
  - エラーハンドリング（ファイル不在、読み込み失敗）を実装
  - _要件: 1.1, 1.3, 9.1_

- [x] 3.2 TimestampExtractor クラスを実装

  - 右上領域からのタイムスタンプ OCR 抽出を実装（pytesseract 使用）
  - ROI 前処理（二値化、ノイズ除去、コントラスト強調）を実装
  - OCR 結果のパース・正規化（HH:MM 形式）を実装
  - タイムスタンプ読み取り失敗時のエラーハンドリングを実装
  - _要件: 1.2, 1.4, 1.6_

- [x] 3.3 FrameSampler クラスを実装（タイムスタンプベース）

  - 5 分刻みの目標タイムスタンプリスト生成ロジックを実装（12:10, 12:15, 12:20...）
  - 動画全体をスキャンし、各フレームのタイムスタンプを抽出
  - 目標タイムスタンプに最も近いフレームを検索（±10 秒許容誤差）
  - 抽出されたフレームとタイムスタンプのペアを返す
  - _要件: 1.3, 1.7_

- [x] 4. Vision Transformer 人物検出モジュールの実装
- [x] 4.1 ViTDetector クラスの基本実装

  - Hugging Face Transformers から DETR モデルをロード
  - MPS デバイス検出と設定（利用不可時は CPU にフォールバック）
  - _要件: 2.1, 2.7, 9.2, 10.4_

- [x] 4.2 検出処理の実装

  - 入力画像の前処理（パッチ分割、正規化）を実装
  - ViT による人物検出（Self-Attention 処理）を実装
  - 検出結果の後処理（信頼度フィルタリング、NMS）を実装
  - バウンディングボックス足元座標の計算を実装
  - _要件: 2.2, 2.3, 2.4, 2.5, 2.6_

- [x] 4.3 Attention Map 可視化機能の実装

  - Attention Map 抽出ロジックを実装
  - デバッグモード時の Attention Map 保存機能を実装
  - _要件: 2.8, 7.4_

- [x] 4.4 バッチ推論の実装

  - 複数フレームのバッチ処理機能を実装
  - メモリ効率化（不要データの即時解放）を実装
  - _要件: 10.2, 10.6_

- [x] 5. 座標変換とゾーン判定の実装（フロアマップ固定パラメータ対応）
- [x] 5.1 CoordinateTransformer クラスを実装

  - ホモグラフィ変換行列の読み込みと検証を実装
  - フロアマップ固定パラメータ（1878×1369 pixel、原点オフセット (7, 9) pixel、スケール 28.19/28.24 mm/pixel）の読み込みを実装
  - カメラ座標 → フロアマップ座標変換（原点オフセット自動適用）を実装
  - ピクセル ⇔mm 変換機能を実装
  - フロアマップ範囲チェック機能を実装
  - バッチ変換機能を実装
  - _要件: 4.1, 4.2, 4.3, 4.4, 4.5, 4.6, 4.7_

- [x] 5.2 ZoneClassifier クラスを実装

  - ゾーン定義の読み込み（ピクセル座標、原点オフセット適用後）を実装
  - 点 in 多角形アルゴリズム（Ray Casting）を実装
  - 複数ゾーン重複時の処理を実装
  - 未分類ゾーンの処理を実装
  - _要件: 5.1, 5.2, 5.3, 5.4, 5.5, 5.6_

- [x] 5.3 FloormapVisualizer クラスを実装

  - フロアマップ画像（1878×1369 pixel）の読み込みを実装
  - ゾーンの半透明多角形描画を実装
  - 検出結果の円描画（ゾーン別色分け）を実装
  - フレーム情報とゾーン別カウントの重畳表示を実装
  - ゾーン凡例の生成を実装
  - 可視化画像の保存機能を実装
  - _要件: 7.1, 7.2, 7.3, 7.4, 7.5, 7.8_

- [x] 6. 集計とレポート生成の実装
- [x] 6.1 Aggregator クラスを実装

  - フレームごとのゾーン別人数カウントを実装
  - 集計結果の蓄積と管理を実装
  - CSV エクスポート機能を実装（timestamp, zone_id, count）
  - 統計情報計算（平均、最大、最小）を実装
  - _要件: 6.1, 6.2, 6.3, 6.4, 6.5_

- [x] 7. 可視化モジュールの実装
- [x] 7.1 Visualizer クラスの実装

  - バウンディングボックス付き画像の生成を実装
  - Attention Map のオーバーレイ表示を実装
  - デバッグモード時の中間処理結果表示を実装
  - _要件: 7.1, 7.4, 7.7_

- [x] 7.2 時系列グラフの生成

  - ゾーン別人数の時系列グラフ（Matplotlib）を実装
  - グラフの PNG 出力を実装
  - _要件: 7.6_

- [x] 8. 精度評価モジュールの実装
- [x] 8.1 EvaluationModule クラスを実装

  - Ground Truth データ（result_fixed.json）の読み込みを実装
  - IoU 計算ロジックを実装
  - Precision, Recall, F1-score 計算を実装
  - 評価レポート（CSV/JSON）の出力を実装
  - _要件: 3.1, 3.2, 3.3, 3.4, 3.5_

- [x] 9. メインパイプラインの統合
- [x] 9.1 main.py の実装

  - コマンドライン引数パーサーを実装（--config, --evaluate, --fine-tune）
  - 全コンポーネントを統合したエンドツーエンド処理フローを実装
  - ロギング設定を実装（ファイル出力、コンソール出力）
  - 進捗表示（tqdm）を実装
  - _要件: 1.1, 1.5, 9.4_

- [x] 9.2 エラーハンドリングの統合

  - 各処理段階でのエラーハンドリングを統合
  - フレーム処理失敗時のスキップ処理を実装
  - エラーログの記録を実装
  - _要件: 9.1, 9.2, 9.3, 9.4_

- [x] 9.3 パフォーマンス最適化の適用

  - MPS デバイスの優先使用を実装
  - バッチ推論の適用を実装
  - メモリ管理の最適化を実装
  - _要件: 10.1, 10.2, 10.4, 10.5, 10.6_

- [ ]\* 10. ファインチューニングモジュールの実装（オプション）
- [ ]\* 10.1 FineTuner クラスを実装

  - Kaggle データセット読み込みを実装
  - データローダーの作成を実装
  - _要件: 3.1.2_

- [ ]\* 10.2 学習ロジックの実装

  - Layer-wise Learning Rate Decay を適用した Optimizer を実装
  - Warmup スケジューラを実装
  - 学習ループを実装
  - _要件: 3.1.3, 3.1.4, 3.1.5_

- [ ]\* 10.3 ファインチューニング評価

  - ファインチューニング後のモデル保存を実装
  - 精度比較レポート生成を実装
  - _要件: 3.1.6, 3.1.7_

- [ ]\* 11. テストの作成
- [ ]\* 11.1 ユニットテストの作成

  - test_config_manager.py を作成
  - test_frame_sampler.py を作成
  - test_coordinate_transformer.py を作成
  - test_zone_classifier.py を作成
  - test_aggregator.py を作成

- [ ]\* 11.2 統合テストの作成

  - エンドツーエンド処理フローのテストを作成
  - サンプル動画を使用した統合テストを作成

- [ ]\* 11.3 精度テストの実行

  - Ground Truth データを使用した精度評価を実行
  - F1-score ≥ 0.85 の達成を確認

- [ ]\* 11.4 パフォーマンステストの実行

  - フレーム処理時間の測定（≤ 2 秒/フレーム）
  - メモリ使用量の測定（≤ 12GB）
  - 全処理時間の測定（≤ 10 分）

- [ ] 12. ドキュメントの作成
  - README.md を作成（概要、セットアップ、使用方法、設定ファイル説明）
  - 各モジュールの docstring を追加
  - 設定ファイルのサンプルとコメントを追加
  - _要件: 8.2_
