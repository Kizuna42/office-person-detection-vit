# 機械学習エンジニア向け：次のアクション計画

## 📊 現状分析

### ✅ 完了している項目

1. **コアパイプライン**: 5 フェーズ（抽出 → 検出 → 変換 → 集計 → 可視化）が正常動作
2. **リファクタリング**: main.py 簡潔化、コード品質向上完了
3. **テスト基盤**: 325 個のテストケースが存在
4. **セッション管理**: 出力管理システムが実装済み
5. **基本機能**: 人物検出、座標変換、ゾーン判定、集計が動作中

### ⚠️ 発見された問題

1. **検出画像保存エラー** (Critical)

   - ログ: `検出画像の保存に失敗しました: detection_2025/08/26 160456.jpg`
   - 原因: ファイルパスにスラッシュ(`/`)が残っている
   - 影響: 検出結果の可視化ができない

2. **ファインチューニング未実装** (High Priority)

   - 要件定義 3.1 で定義されているが未実装
   - 精度向上のための重要な機能

3. **テストカバレッジ未確認** (Medium Priority)
   - 325 個のテストは存在するが、カバレッジ率が不明
   - 目標: ≥80%

### 📈 パフォーマンス指標

- **検出精度**: 平均 21.25 人/フレーム、信頼度 0.85（良好）
- **処理速度**: 4 フレーム処理完了（正常）
- **エラー率**: 検出画像保存で 100%失敗（要修正）

---

## 🎯 優先度別アクションプラン

### 🔴 Priority 1: クリティカルバグ修正（即座に対応）

#### 1.1 検出画像保存エラーの修正

**問題**: `timestamp.replace("/", "_")`が不完全で、パスに`/`が残る

**修正方針**:

```python
# src/utils/image_utils.py
# 現在のコード（不完全）
timestamp_clean = timestamp.replace("/", "_").replace(":", "").replace(" ", "_")

# 修正案
timestamp_clean = timestamp.replace("/", "_").replace(":", "").replace(" ", "_")
# さらに、Pathオブジェクトで安全に処理
filename = f"detection_{timestamp_clean}.jpg"
output_path = output_dir / filename
```

**実装タスク**:

- [ ] `save_detection_image()`関数の修正
- [ ] ファイル名生成ロジックの改善（Path 操作を使用）
- [ ] テストケース追加（特殊文字を含むタイムスタンプ）
- [ ] 既存セッションでの動作確認

**期待効果**: 検出画像が正常に保存され、デバッグと可視化が可能になる

---

### 🟡 Priority 2: モデル精度向上（1-2 週間）

#### 2.1 ファインチューニングモジュール実装

**要件**: 要件定義 3.1 に基づく実装

**実装計画**:

**Phase 1: データ準備**

- [ ] Kaggle データセット「Office object detection」のダウンロード・前処理
- [ ] COCO 形式への変換スクリプト作成
- [ ] データローダーの実装（バッチ処理、データ拡張）

**Phase 2: ファインチューニング実装**

- [ ] `src/detection/fine_tuner.py`の作成
- [ ] Transformer 特有の学習戦略実装:
  - Layer-wise Learning Rate Decay
  - Warmup スケジューラー
  - Gradient Accumulation（メモリ効率化）
- [ ] ハイパーパラメータ設定（config.yaml）
- [ ] チェックポイント保存・ロード機能

**Phase 3: 評価・比較**

- [ ] ファインチューニング前後の精度比較
- [ ] Attention Map 可視化の比較
- [ ] レポート生成機能

**技術スタック**:

- PyTorch Lightning（推奨）または カスタム訓練ループ
- Hugging Face Transformers（モデルロード）
- Weights & Biases または TensorBoard（実験管理）

**期待効果**: F1-score 0.85 以上を達成（現在の精度から向上）

---

### 🟢 Priority 3: 品質保証・テスト強化（1 週間）

#### 3.1 テストカバレッジ測定と改善

**現状**: 325 個のテストケース存在、カバレッジ率不明

**タスク**:

- [ ] カバレッジ測定: `pytest --cov=src --cov-report=html tests/`
- [ ] カバレッジレポート分析（80%未満のモジュール特定）
- [ ] 不足しているテストケースの追加:
  - エッジケース（空の検出結果、異常な座標など）
  - エラーハンドリング（ファイル不存在、メモリ不足など）
  - 統合テスト（全フェーズ連携）
- [ ] CI/CD へのカバレッジ閾値設定（80%）

**目標**: テストカバレッジ ≥80%

#### 3.2 パフォーマンスベンチマーク

**タスク**:

- [ ] 各フェーズの処理時間測定
- [ ] メモリ使用量プロファイリング
- [ ] ボトルネック特定（cProfile 使用）
- [ ] ベンチマークレポート生成

**目標値**:

- フレーム処理時間: ≤2 秒/フレーム（MPS 使用時）
- メモリ使用量: ≤12GB
- 全処理時間: ≤10 分（1 時間分のタイムラプス動画）

---

### 🔵 Priority 4: 機能拡張・最適化（2-3 週間）

#### 4.1 トラッキング機能実装

**背景**: ユーザー要望（フレーム間での人物追跡）

**実装計画**:

- [ ] DeepSORT または ByteTrack ベースのトラッキング実装
- [ ] 特徴量抽出（ReID モデルまたは DETR の特徴量）
- [ ] トラッキング ID の付与と可視化
- [ ] トラッキング結果の集計（滞在時間、移動パターン）

**技術選択**:

- **DeepSORT**: Kalman Filter + Hungarian Algorithm
- **ByteTrack**: よりシンプルで高速
- **ReID**: 外観特徴量による再識別

#### 4.2 モデル選択の拡張

**タスク**:

- [ ] ViT-Det モデルのサポート追加
- [ ] YOLOv8/YOLOv9 との比較評価
- [ ] モデル選択機能（config.yaml で指定）

#### 4.3 リアルタイム処理対応（オプション）

**タスク**:

- [ ] ストリーミング入力対応
- [ ] フレームバッファリング
- [ ] リアルタイム可視化ダッシュボード

---

### 🟣 Priority 5: ドキュメント・運用改善（継続的）

#### 5.1 ドキュメント整備

**タスク**:

- [ ] API ドキュメント生成（Sphinx 使用）
- [ ] チュートリアル作成（Jupyter Notebook）
- [ ] アーキテクチャ図の更新
- [ ] トラブルシューティングガイド拡充

#### 5.2 モニタリング・ログ改善

**タスク**:

- [ ] 構造化ログ（JSON 形式）への移行
- [ ] メトリクス収集（Prometheus 形式）
- [ ] アラート設定（エラー率、処理時間）

---

## 📅 推奨タイムライン

### Week 1: クリティカルバグ修正

- Day 1-2: 検出画像保存エラー修正
- Day 3-4: テスト追加・動作確認
- Day 5: リリース準備

### Week 2-3: ファインチューニング実装

- Week 2: データ準備・学習ループ実装
- Week 3: 評価・比較・ドキュメント

### Week 4: テスト強化・ベンチマーク

- Day 1-2: カバレッジ測定・改善
- Day 3-4: パフォーマンスベンチマーク
- Day 5: レポート作成

### Week 5 以降: 機能拡張

- トラッキング機能実装
- モデル選択拡張
- リアルタイム処理（オプション）

---

## 🎓 機械学習エンジニアとしての推奨事項

### 1. **実験管理の導入**

- Weights & Biases (W&B) または MLflow の導入
- ハイパーパラメータ最適化（Optuna 使用）
- 実験結果の可視化と比較

### 2. **モデル評価の強化**

- mAP (mean Average Precision) の計算
- PR 曲線、ROC 曲線の可視化
- 誤検出・検出漏れの分析（Confusion Matrix）

### 3. **データ品質の確保**

- Ground Truth データの拡充（80 枚 →200 枚以上）
- データ拡張（Augmentation）の適用
- データバリデーション

### 4. **モデル最適化**

- 量子化（INT8）による推論高速化
- ONNX 形式へのエクスポート
- TensorRT/MPS 最適化

### 5. **継続的改善**

- A/B テストフレームワーク
- モデル再訓練パイプライン（自動化）
- ドリフト検出（データ分布変化の検知）

---

## 📝 次のステップ（今すぐ実行）

1. **検出画像保存エラーの修正**（30 分）

   ```bash
   # 修正後、テスト実行
   pytest tests/test_detection_phase.py -v
   python main.py --timestamps-only  # 動作確認
   ```

2. **テストカバレッジ測定**（1 時間）

   ```bash
   pytest --cov=src --cov-report=html tests/
   # htmlcov/index.html を確認
   ```

3. **ファインチューニング設計書作成**（2 時間）
   - データセット仕様
   - 学習パイプライン設計
   - 評価指標定義

---

## 🔗 参考リソース

- [DETR 論文](https://arxiv.org/abs/2005.12872)
- [Vision Transformer 論文](https://arxiv.org/abs/2010.11929)
- [PyTorch Lightning](https://lightning.ai/docs/pytorch/stable/)
- [Weights & Biases](https://wandb.ai/)

---

**作成日**: 2025-11-07
**分析者**: AI Assistant (機械学習エンジニア視点)
**次回レビュー**: 1 週間後
