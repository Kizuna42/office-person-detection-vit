# カメラ方向の仕様定義

## 仕様概要

**`yaw=0`, `roll=0` のデフォルト状態で、カメラはフロアマップ座標系の右下方向を向きます。**

この仕様により、カメラの向きを直感的に設定できます。

## 座標系の定義

### フロアマップ座標系
- **原点**: 画像左上 (0, 0)
- **X軸**: 右方向が正（+X）
- **Y軸**: 下方向が正（+Y）
- **Z軸**: 上方向が正（+Z、フロアマップ平面から上）

### 右下方向の定義
フロアマップ座標系で「右下方向」とは：
- **+X方向（右）** と **+Y方向（下）** の組み合わせ
- 角度で表すと **約45度**（`atan2(Y, X) = atan2(1, 1) = 45度`）

## パラメータの定義

### Yaw（方位角）
- **デフォルト値**: `0.0` 度
- **デフォルト時の向き**: フロアマップ座標系で右下方向（+X, +Y）
- **正の値**: 時計回り（右方向に回転）
- **負の値**: 反時計回り（左方向に回転）

**例**:
- `yaw_deg: 0.0` → 右下方向
- `yaw_deg: 45.0` → 右方向（右下から45度時計回り）
- `yaw_deg: -45.0` → 下方向（右下から45度反時計回り）
- `yaw_deg: 90.0` → 右上方向（右下から90度時計回り）
- `yaw_deg: -90.0` → 左下方向（右下から90度反時計回り）

### Pitch（俯角）
- **デフォルト値**: `0.0` 度（水平方向）
- **正の値**: 上向き
- **負の値**: 下向き（推奨: -10 〜 -15度で人物を見下ろす）

**例**:
- `pitch_deg: 0.0` → 水平方向
- `pitch_deg: -12.0` → 軽く下向き（人物を見下ろす）
- `pitch_deg: -45.0` → 強い下向き

### Roll（回転角）
- **デフォルト値**: `0.0` 度（水平）
- **正の値**: 時計回りに傾き
- **負の値**: 反時計回りに傾き

## 推奨設定

### 標準的な右下向き（デフォルト）

```yaml
camera_params:
  height_m: 2.2
  pitch_deg: -12.0        # 軽く下向き
  yaw_deg: 0.0            # 右下方向（デフォルト）
  roll_deg: 0.0           # 水平（デフォルト）
  focal_length_x: 1250.0
  focal_length_y: 1250.0
  center_x: 640.0
  center_y: 360.0
  position_x: 859         # カメラ位置（固定点）
  position_y: 1040        # カメラ位置（固定点）
```

### 他の方向への調整例

```yaml
# 右方向を向く
yaw_deg: 45.0

# 下方向を向く
yaw_deg: -45.0

# 左下方向を向く
yaw_deg: -90.0

# 右上方向を向く
yaw_deg: 90.0
```

## 実装の詳細

`CoordinateTransformer.compute_homography_from_params()` では、以下のように実装されています：

1. **基底変換**: World座標系からCamera座標系への変換（`R_base_world_to_cam`）
2. **右下方向オフセット**: yaw=0の時に右下方向を向くための回転（`R_yaw_offset`、135度）
3. **ユーザー指定回転**: Pitch、Yaw、Rollの組み合わせ（`R_user`）

最終的な回転行列は：
```python
R = R_user @ R_yaw_offset @ R_base_world_to_cam
```

これにより、`yaw=0, roll=0`の時にフロアマップ座標系で右下方向（45度）を向くようになります。

## 検証方法

### テストスクリプトでの確認

```bash
python tools/test_camera_direction.py --config config.yaml
```

出力例（正常な場合）:
```
中心  : 角度   45.0度 (右下), 距離  366.8px
✓ 中心方向が右下（30-60度）を向いています: 45.0度
```

### 視覚的ツールでの確認

```bash
python tools/adjust_camera_params.py \
  --config config.yaml \
  --image output/latest/phase1_extraction/frames/frame_20250826_160500_idx4.jpg
```

- フロアマップ上に投影されたグリッド線が、カメラ画像と一致するか確認
- `yaw_deg: 0.0`の時に、カメラ位置から右下方向に末広がりになっているか確認

## 後方互換性

この仕様変更により、既存の設定ファイルで`yaw_deg: 45.0`（旧仕様での下方向）を使用している場合、新仕様では右方向を向くようになります。

**移行方法**:
1. 既存の`yaw_deg`値を`0.0`に変更（右下方向を維持）
2. または、既存の角度の符号を反転（方向を維持）

**例**:
- 旧設定: `yaw_deg: 45.0`（旧仕様での下方向）
- 新設定: `yaw_deg: -45.0`（新仕様での下方向、符号を反転）
- 旧設定: `yaw_deg: -45.0`（旧仕様での右方向）
- 新設定: `yaw_deg: 45.0`（新仕様での右方向、符号を反転）

## まとめ

- **デフォルト（yaw=0, roll=0）**: フロアマップ座標系で右下方向を向く
- **Yaw調整**: 右下方向から時計回りに回転（正の値=右方向）または反時計回りに回転（負の値=左方向）
- **直感的な設定**: 正の値で右方向に回転するため、直感的に操作できる
- **テストで検証**: `test_camera_direction.py`で方向を確認
