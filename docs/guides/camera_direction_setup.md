# カメラ方向設定ガイド：右下向き末広がり画角

## 概要

カメラがフロアマップ座標系で**右下方向に末広がり（扇状）の画角**を持つように設定する方法とパラメータ調整のポイントを説明します。

## 座標系の定義

### フロアマップ座標系

- **原点**: 画像左上 (0, 0)
- **X 軸**: 右方向が正（+X）
- **Y 軸**: 下方向が正（+Y）
- **右下方向**: +X 方向（右）かつ +Y 方向（下）

### カメラ座標系

- **World 座標系**: X=右, Y=奥（前）, Z=上
- **Camera 座標系**: X=右, Y=下, Z=奥（前）
- **回転の定義**:
  - **Pitch（俯角）**: X 軸周り回転（正=下向き、負=上向き）
  - **Yaw（方位角）**: Y 軸周り回転（左右パン）
  - **Roll（回転角）**: Z 軸周り回転（左右傾き）

## 右下向き末広がり画角の設定

### 1. Yaw（方位角）の設定

フロアマップ座標系で右下方向を向くには：

```
右下方向の角度 = atan2(Y方向成分, X方向成分)
```

フロアマップ座標系では：

- **X 軸正方向（右）**: 0 度基準から時計回り
- **Y 軸正方向（下）**: +90 度方向
- **右下方向**: 約 +45 度（X と Y が等しい場合）

**ただし**、実装の座標系変換により、実際の角度は異なる可能性があります。

### 2. Pitch（俯角）の設定

カメラが下方向を見る場合、**負の値**を使用します：

- `pitch_deg: 0` = 水平方向
- `pitch_deg: -10` 〜 `-15` = 軽く下向き（2.2m の高さから人物を見下ろす）
- `pitch_deg: -45` = 強い下向き（過度）

**推奨**: `-10.0` 〜 `-15.0` 度

### 3. FOV（視野角）の設定

末広がり（扇状）の広がりを作るには、適切な視野角が必要です：

```
焦点距離（px） = (画像幅 / 2) / tan(FOV / 2)
```

**推奨 FOV 値**:

- **水平 FOV**: 50 度 〜 60 度（末広がり効果）
- **垂直 FOV**: 30 度 〜 40 度（適度な縦方向の広がり）

現在の設定（1280×720、焦点距離 1250px）の場合：

- **水平 FOV**: 約 51.3 度（適切）
- **垂直 FOV**: 約 30.5 度（適切）

## パラメータ候補

### パターン 1：標準的な右下向き（推奨）

```yaml
camera_params:
  height_m: 2.2
  pitch_deg: -12.0 # 軽く下向き（人物を見下ろす）
  yaw_deg: 45.0 # 右下方向（XとYが等しい方向）
  roll_deg: 0.0 # 水平
  focal_length_x: 1250.0 # FOV約51度（適度な広がり）
  focal_length_y: 1250.0
  center_x: 640.0 # 画像中心
  center_y: 360.0 # 画像中心
  position_x: 859 # カメラ位置（固定点）
  position_y: 1040 # カメラ位置（固定点）
```

### パターン 2：より広い末広がり

```yaml
camera_params:
  height_m: 2.2
  pitch_deg: -10.0 # より浅い俯角
  yaw_deg: 40.0 # やや右寄り
  roll_deg: 0.0
  focal_length_x: 1100.0 # より広いFOV（約58度）
  focal_length_y: 1100.0
  center_x: 640.0
  center_y: 360.0
  position_x: 859
  position_y: 1040
```

### パターン 3：より狭い集中型

```yaml
camera_params:
  height_m: 2.2
  pitch_deg: -15.0 # より強い俯角
  yaw_deg: 50.0 # やや下寄り
  roll_deg: 0.0
  focal_length_x: 1400.0 # より狭いFOV（約46度）
  focal_length_y: 1400.0
  center_x: 640.0
  center_y: 360.0
  position_x: 859
  position_y: 1040
```

## 実装修正ポイント

### 1. 座標系の変換順序の確認

現在の実装では、回転行列の適用順序が複雑です：

```python
# src/transform/coordinate_transformer.py の compute_homography_from_params()
R_user = Rz @ Ry @ Rx  # 適用順序: Roll → Yaw → Pitch
R = R_user @ R_base
```

**問題点**:

- 回転の適用順序により、Yaw と Pitch の意味が期待と異なる可能性がある
- World 座標系と Camera 座標系の変換（`R_base`）が複雑

**改善案**:

- 回転順序を明確化し、ドキュメント化
- または、より直感的な座標系変換に変更

### 2. Yaw 角度の定義の明確化

現在のコメントには「0=正面, -90=左, 90=右」とありますが、これがフロアマップ座標系での方向を指しているか不明確です。

**改善案**:

- フロアマップ座標系での方向定義を明確化
- 右下方向の角度を計算するユーティリティ関数を追加

```python
def calculate_yaw_for_direction(target_x: float, target_y: float,
                                camera_x: float, camera_y: float) -> float:
    """フロアマップ座標系で指定方向を向くためのYaw角度を計算

    Args:
        target_x: 目標方向のX座標
        target_y: 目標方向のY座標
        camera_x: カメラ位置のX座標
        camera_y: カメラ位置のY座標

    Returns:
        Yaw角度（度）
    """
    dx = target_x - camera_x
    dy = target_y - camera_y
    angle_rad = np.arctan2(dy, dx)  # フロアマップ座標系での角度
    angle_deg = np.degrees(angle_rad)

    # World座標系に変換（必要に応じて調整）
    # 実装に依存するため、テストが必要
    return angle_deg
```

### 3. 視覚的検証ツールの活用

`adjust_camera_params.py` を使用して、実際の画角を確認：

```bash
python tools/adjust_camera_params.py \
  --config config.yaml \
  --image output/latest/phase1_extraction/frames/frame_20250826_160500_idx4.jpg
```

**確認ポイント**:

1. フロアマップ上に投影されたグリッド線が、カメラ画像と一致するか
2. カメラ位置から右下方向に末広がりになっているか
3. 実際の人物位置と変換後の位置が一致するか

## 調整手順

### Step 1: 初期設定

```yaml
camera_params:
  pitch_deg: -12.0
  yaw_deg: 45.0
  focal_length_x: 1250.0
  focal_length_y: 1250.0
```

### Step 2: 視覚的検証

`adjust_camera_params.py` でグリッド線を確認しながら微調整：

1. **Yaw 調整**: グリッド線が右下方向に広がるように調整

   - 右に広がりすぎ → Yaw を小さく（30-40 度）
   - 下に広がりすぎ → Yaw を大きく（50-60 度）

2. **Pitch 調整**: 俯角を調整

   - 遠くが見えない → Pitch を小さく（-8 度）
   - 近すぎる → Pitch を大きく（-15 度）

3. **FOV 調整**: 末広がりの広がりを調整
   - 広がりが足りない → FOV を大きく（焦点距離を小さく）
   - 広がりすぎ → FOV を小さく（焦点距離を大きく）

### Step 3: 実画像での検証

実際のカメラ画像で人物を検出し、フロアマップ上での位置が正しいか確認。

## トラブルシューティング

### 問題 1: 画角が期待と逆方向を向いている

**原因**: 座標系の定義が逆の可能性

**解決策**:

- `yaw_deg` の符号を反転（45 度 → -45 度）
- または、座標系変換を修正

### 問題 2: 末広がりが不自然

**原因**: FOV が不適切、または回転角度の組み合わせが悪い

**解決策**:

- FOV を調整（焦点距離を変更）
- Pitch と Yaw のバランスを調整

### 問題 3: 変換後の座標がずれる

**原因**: カメラ位置や座標系の変換が正しくない

**解決策**:

- カメラ位置（`position_x/y`）を再確認
- ホモグラフィ変換行列の計算を検証

## まとめ

右下向き末広がり画角を実現するには：

1. **Yaw（方位角）**: 約 40-50 度（右下方向）
2. **Pitch（俯角）**: 約 -10 〜 -15 度（軽く下向き）
3. **FOV（視野角）**: 約 50-60 度（末広がり効果）
4. **カメラ位置**: 固定点として正しく設定

**重要なポイント**:

- 座標系の定義を理解する
- 視覚的ツールで確認しながら調整
- 実画像での検証が最良の方法
