# P0-施策11: 時系列補正の改善（_last_timestamp更新ロジック）

## 優先度
**P0（緊急対応: 即座に実施）**

## 目的
時系列補正がより厳格に機能するように、`_last_timestamp`の更新ロジックを改善する。

## 問題背景
- `_last_timestamp`が誤認識された結果で更新されてしまう
- 時系列補正ロジック（施策2）は実装済みだが、`_last_timestamp`の更新前にチェックが不十分
- 信頼度が低い結果でも、`_last_timestamp`が更新されてしまう

## 実装内容

### 1. _last_timestamp更新前の再チェック
- `parse_timestamp()`内で、`_last_timestamp`を更新する前に時系列整合性を再チェック
- ±7日以上の差がある場合は、`_last_timestamp`を更新しない
- 時系列が逆転している場合も、`_last_timestamp`を更新しない

### 2. 信頼度による更新制御
- 信頼度が低い結果（< 0.3）は、`_last_timestamp`を更新しない
- 信頼度が高い結果（≥ 0.7）のみ、`_last_timestamp`を更新
- 中間の信頼度（0.3-0.7）は、時系列整合性を厳格にチェックしてから更新

### 3. 更新履歴の保持
- `_last_timestamp`の更新履歴を保持（最大10件）
- 更新履歴から、時系列整合性をより厳格にチェック
- 異常な更新を検出した場合、警告ログに記録

## 期待効果
**精度向上: 40-60%**

## 実装ファイル
- `src/timestamp/timestamp_extractor.py`
  - `parse_timestamp()`メソッドの修正
  - `_update_last_timestamp()`メソッドの追加（新規）
  - `_last_timestamp_history`の追加（新規）

## 実装工数
**1-2日**

## 検証方法
- `_last_timestamp`の更新ロジックの妥当性を検証
- 信頼度による更新制御の効果を評価
- 更新履歴による整合性チェックの効果を測定

## 成功基準
- `_last_timestamp`の誤更新率 ≤ 5%
- 信頼度による更新制御の精度 ≥ 90%
- 更新履歴による整合性チェックの精度 ≥ 95%

## 関連施策
- 施策2: 時系列補正ロジックの厳格化（連携必要）
- 施策9: 最後のフレーム検証と再試行メカニズム（連携可能）
- 施策10: 信頼度閾値による結果フィルタリング（連携必要）

