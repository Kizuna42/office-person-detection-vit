# P0-施策9: 最後のフレーム検証と再試行メカニズム

## 優先度
**P0（緊急対応: 即座に実施）**

## 目的
最後のフレーム群での誤認識を防止し、最終タイムスタンプの精度を向上させる。

## 問題背景
- フレーム23931-23939で誤認識（2025/08/02 09:13:44）が継続
- 信頼度0.00の結果が採用されている
- 最後のフレーム（23940）のみ正しく認識（2025/08/29 13:45:39）
- 最初のフレーム検証（施策1）は効果があるが、最後のフレーム群には適用されていない

## 実装内容

### 1. 最後のNフレームでの多数決
- 最後のNフレーム（例: 最後の10フレーム）でOCRを実行
- 各フレームのタイムスタンプを抽出
- 多数決で最終タイムスタンプを決定
- 信頼度が低い結果（< 0.3）は除外

### 2. 信頼度0.00の結果を除外
- 信頼度0.00の結果を自動除外
- 信頼度閾値（0.3）以下の結果を警告ログに記録
- 信頼度が低い場合は、近傍フレームでの再試行を実施

### 3. 時系列整合性チェック
- 前のフレームとの差が±7日以上の場合、除外
- 時系列が逆転している場合（過去のタイムスタンプより前）、除外
- 複数のOCRエンジンでアンサンブル

## 期待効果
**精度向上: 70-85%**

## 実装ファイル
- `src/timestamp/timestamp_extractor.py`
  - 新規メソッド: `_extract_final_timestamp_with_consensus()`
  - `extract()`メソッドの修正
- `src/video/frame_sampler.py`
  - `_scan_all_timestamps()`メソッドの修正
  - 最後のフレーム検証の統合

## 実装工数
**2-3日**

## 検証方法
- 最後の10フレームでのタイムスタンプ抽出精度を測定
- 信頼度0.00の結果の除外率を記録
- 時系列整合性チェックの効果を評価

## 成功基準
- 最後のフレーム群での日付誤認識率 ≤ 5%
- 信頼度0.00の結果の除外率 ≥ 95%
- 最終タイムスタンプの妥当性チェック成功率 ≥ 95%

## 関連施策
- 施策1: 最初のフレーム検証と再試行メカニズム（対称的な実装）
- 施策10: 信頼度閾値による結果フィルタリング（連携必要）
- 施策11: 時系列補正の改善（連携必要）

