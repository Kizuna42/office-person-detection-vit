# OCR 精度不良の原因分析および精度向上計画

## ① 問題概要

### 現状の問題

- **実際の動画データ**: 2025/08/26 16:04:16 ～ 2025/08/29 13:45:39（約 13 分 18 秒、798.03 秒）
- **OCR 出力結果**: 2025/08/02 06:16:04 ～ 2025/08/02 09:13:45（約 2 時間 57 分 41 秒、10,661 秒）
- **不整合の特徴**:
  - 日付が完全に異なる（8/26-29 vs 8/02）
  - 動画の長さが約 13.4 倍に誤認識（798 秒 vs 10,661 秒）
  - 最初のフレーム（0-4）と最後のフレーム（23936-23940）で同一タイムスタンプが検出

### 影響範囲

- フレームサンプリングの失敗
- タイムスタンプベースの集計処理の誤動作
- データの信頼性低下

## ② 原因分析

### 2.1 主な原因要因

#### A. 最初のフレームでの OCR 誤認識（最重要）

**影響度**: 極めて高い（★★★★★）

- **問題**: フレーム 0 で日付が誤認識（2025/08/26 → 2025/08/02）
- **根拠**:
  - `_last_timestamp`が最初のフレームの結果で初期化される
  - 時系列補正ロジック（`parse_timestamp`）が履歴を参照して補正するため、誤認識が継続
- **コード箇所**: `src/timestamp/timestamp_extractor.py:649-794`

#### B. 時系列補正ロジックの不適切さ

**影響度**: 高い（★★★★☆）

- **問題**:
  - ±12 時間以内の日付跨ぎは許容（`timestamp_extractor.py:772-791`）
  - 3 年以上の差は破棄するが、それ以下の差は許容（`timestamp_extractor.py:766-770`）
  - 24 日間（8/02 → 8/26）の差は許容範囲内と判定される可能性
- **根拠**: 補正ロジックが緩すぎて、誤認識を正しく検出できない

#### C. 前処理パラメータの不最適

**影響度**: 中程度（★★★☆☆）

- **問題**:
  - CLAHE、リサイズ、二値化のパラメータが固定値
  - 照明条件やフレーム品質に応じた適応処理が不足
- **コード箇所**: `src/detection/preprocessing.py:284-360`
- **現状設定**:
  - CLAHE: `clip_limit=2.0, tile_grid_size=(8,8)`
  - リサイズ: `fx=2.0`
  - 二値化: Otsu 法

#### D. ROI 領域の問題

**影響度**: 中程度（★★★☆☆）

- **問題**:
  - ROI 座標が固定（`900, 30, 360, 45`）
  - フレームブレや解像度不足でタイムスタンプ領域が不完全に抽出される可能性
- **コード箇所**: `src/timestamp/timestamp_extractor.py:53`

#### E. OCR エンジン設定の限界

**影響度**: 中程度（★★★☆☆）

- **問題**:
  - Tesseract のみに依存（PaddleOCR、EasyOCR はオプション）
  - PSM 設定の多数決は実装済みだが、日付部分の誤認識には効果が限定的
- **コード箇所**: `src/timestamp/timestamp_extractor.py:140-236`

#### F. 外れ値検知の不十分さ

**影響度**: 中程度（★★★☆☆）

- **問題**:
  - フレームサンプラーでは ±120 秒以内の差を許容（`frame_sampler.py:780`）
  - 日付レベルの誤認識（24 日間）は検出できない
- **コード箇所**: `src/video/frame_sampler.py:763-785`

#### G. 最後のフレーム群での誤認識継続（新規発見）

**影響度**: 極めて高い（★★★★★）

- **問題**:
  - フレーム 23931-23939 で誤認識（2025/08/02 09:13:44）が継続
  - 信頼度が 0.00 の結果が採用されている
  - 最後のフレーム（23940）のみ正しく認識（2025/08/29 13:45:39）
- **根拠**:
  - 最初のフレーム検証（施策 1）は効果があるが、最後のフレーム群には適用されていない
  - 信頼度 0.00 の結果を除外するロジックが不足
  - 時系列補正が最後のフレーム群で正しく機能していない

### 2.2 影響度の定量的評価

| 要因                   | 影響度     | 推定精度低下率 | 優先度 |
| ---------------------- | ---------- | -------------- | ------ |
| 最初のフレーム誤認識   | 極めて高い | 80-100%        | P0     |
| 最後のフレーム群誤認識 | 極めて高い | 70-90%         | P0     |
| 時系列補正ロジック     | 高い       | 50-80%         | P0     |
| 前処理パラメータ       | 中程度     | 20-40%         | P1     |
| ROI 領域               | 中程度     | 10-30%         | P1     |
| OCR エンジン設定       | 中程度     | 15-25%         | P1     |
| 外れ値検知             | 中程度     | 10-20%         | P2     |

## ③ 改善施策一覧

### 3.1 緊急対応（P0: 即座に実施）

#### 施策 1: 最初のフレーム検証と再試行メカニズム ✅ 実装済み

**目的**: 最初のフレームでの誤認識を防止

**実装内容**:

- 最初の N フレーム（例: 0-10）で OCR を実行し、多数決で初期タイムスタンプを決定
- 初期タイムスタンプの妥当性チェック（現在時刻 ±30 日以内など）
- 複数の OCR エンジン（Tesseract、PaddleOCR、EasyOCR）でアンサンブル

**期待効果**: 精度向上 60-80%

**実装状況**: ✅ 実装完了（効果確認済み：最初のフレームは正しく認識）

#### 施策 2: 時系列補正ロジックの厳格化 ✅ 実装済み

**目的**: 誤認識の継続を防止

**実装内容**:

- 日付レベルの外れ値検知を追加（前回フレームとの差が ±1 日以上の場合、警告・再検証）
- 3 年以上の差だけでなく、±7 日以上の差も警告ログを出力し、破棄
- `_multi_ocr_vote()`内でも時系列整合性チェックを実施

**期待効果**: 精度向上 40-60%

**実装状況**: ✅ 実装完了（部分的に効果あり）

#### 施策 3: 日付部分の独立検証 ✅ 実装済み

**目的**: 日付と時刻を分離して検証

**実装内容**:

- 日付部分（YYYY/MM/DD）と時刻部分（HH:MM:SS）を独立して OCR 実行
- 日付部分は複数の OCR エンジンでアンサンブル
- 日付の妥当性チェック（月: 1-12、日: 1-31、年: 2000-2100）

**期待効果**: 精度向上 50-70%

**実装状況**: ✅ 実装完了

#### 施策 9: 最後のフレーム検証と再試行メカニズム（新規）

**目的**: 最後のフレーム群での誤認識を防止

**実装内容**:

- 最後の N フレーム（例: 最後の 10 フレーム）で OCR を実行し、多数決で最終タイムスタンプを決定
- 信頼度 0.00 の結果を除外
- 時系列整合性チェック（前のフレームとの差が ±7 日以上の場合、除外）
- 複数の OCR エンジンでアンサンブル

**期待効果**: 精度向上 70-85%

**実装ファイル**: `src/timestamp/timestamp_extractor.py`, `src/video/frame_sampler.py`

**実装工数**: 2-3 日

**優先度**: P0（緊急対応）

#### 施策 10: 信頼度閾値による結果フィルタリング（新規）

**目的**: 信頼度が低い結果を除外し、誤認識を防止

**実装内容**:

- 信頼度 0.00 の結果を自動除外
- 信頼度閾値（例: 0.3）以下の結果を警告ログに記録
- 信頼度が低い場合は、近傍フレームでの再試行を実施

**期待効果**: 精度向上 30-50%

**実装ファイル**: `src/timestamp/timestamp_extractor.py`

**実装工数**: 1-2 日

**優先度**: P0（緊急対応）

#### 施策 11: 時系列補正の改善（\_last_timestamp 更新ロジック）（新規）

**目的**: 時系列補正がより厳格に機能するように改善

**実装内容**:

- `_last_timestamp`の更新前に、時系列整合性を再チェック
- ±7 日以上の差がある場合は、`_last_timestamp`を更新しない
- 信頼度が低い結果（< 0.3）は、`_last_timestamp`を更新しない

**期待効果**: 精度向上 40-60%

**実装ファイル**: `src/timestamp/timestamp_extractor.py`

**実装工数**: 1-2 日

**優先度**: P0（緊急対応）

### 3.2 重要対応（P1: 1-2 週間以内）

#### 施策 4: 前処理パラメータの最適化 ✅ 実装済み

**目的**: OCR 認識率の向上

**実装内容**:

- フレーム品質に応じた適応的前処理（コントラスト、明るさの自動調整）
- 複数の前処理パイプラインを試行し、最高信頼度の結果を選択

**期待効果**: 精度向上 20-40%

**実装状況**: ✅ 実装完了

#### 施策 5: ROI 領域の動的調整 ✅ 実装済み

**目的**: フレームブレに対応

**実装内容**:

- 複数の ROI 候補領域を試行（右上、左上など）
- ROI 領域の品質評価（コントラスト、エッジ密度）

**期待効果**: 精度向上 15-30%

**実装状況**: ✅ 実装完了

#### 施策 6: 複数 OCR エンジンのアンサンブル強化 ✅ 実装済み

**目的**: 単一エンジンの誤認識を補完

**実装内容**:

- Tesseract、PaddleOCR、EasyOCR の結果を重み付き投票
- 各エンジンの信頼度に基づく重み付け
- 時系列整合性チェックをアンサンブル段階で実施

**期待効果**: 精度向上 25-35%

**実装状況**: ✅ 実装完了

### 3.3 中長期対応（P2: 1 ヶ月以内）

#### 施策 7: 外れ値検知の強化 ✅ 実装済み

**目的**: 異常なタイムスタンプを早期検出

**実装内容**:

- フレーム間の時間差の統計的検定（Z-score 法）
- 日付レベルの外れ値検知（±1 日以上の差を警告）

**期待効果**: 精度向上 10-20%

**実装状況**: ✅ 実装完了

#### 施策 8: タイムスタンプ専用モデルの検討 ✅ 実装済み（インターフェース）

**目的**: OCR エンジンに依存しない高精度認識

**実装内容**:

- タイムスタンプ専用の CNN/Transformer モデルの訓練（将来実装）
- ファインチューニング用データセットの構築

**期待効果**: 精度向上 30-50%（長期的）

**実装状況**: ✅ インターフェース実装完了

## ④ 実施優先度と期待効果

### 優先度マトリクス

| 施策                              | 優先度 | 実装工数   | 期待効果   | 実施時期 | 実装状況                |
| --------------------------------- | ------ | ---------- | ---------- | -------- | ----------------------- |
| 施策 1: 最初のフレーム検証        | P0     | 2-3 日     | 60-80%     | 即座     | ✅ 完了                 |
| 施策 2: 時系列補正厳格化          | P0     | 1-2 日     | 40-60%     | 即座     | ✅ 完了                 |
| 施策 3: 日付独立検証              | P0     | 2-3 日     | 50-70%     | 即座     | ✅ 完了                 |
| **施策 9: 最後のフレーム検証**    | **P0** | **2-3 日** | **70-85%** | **即座** | **未実装**              |
| **施策 10: 信頼度フィルタリング** | **P0** | **1-2 日** | **30-50%** | **即座** | **未実装**              |
| **施策 11: 時系列補正改善**       | **P0** | **1-2 日** | **40-60%** | **即座** | **未実装**              |
| 施策 4: 前処理最適化              | P1     | 3-5 日     | 20-40%     | 1-2 週間 | ✅ 完了                 |
| 施策 5: ROI 動的調整              | P1     | 2-3 日     | 15-30%     | 1-2 週間 | ✅ 完了                 |
| 施策 6: OCR アンサンブル          | P1     | 2-3 日     | 25-35%     | 1-2 週間 | ✅ 完了                 |
| 施策 7: 外れ値検知強化            | P2     | 2-3 日     | 10-20%     | 1 ヶ月   | ✅ 完了                 |
| 施策 8: 専用モデル                | P2     | 2-3 週間   | 30-50%     | 1-3 ヶ月 | ✅ インターフェース完了 |

### 累積効果の推定（更新）

- **P0 施策のみ実施（施策 1-3）**: 精度向上 70-90%（現在の誤認識率 80-100% → 10-30%）
- **P0 施策全実施（施策 1-3, 9-11）**: 精度向上 85-95%（誤認識率 → 5-15%）
- **P0+P1 施策実施**: 精度向上 90-98%（誤認識率 → 2-10%）
- **全施策実施**: 精度向上 95-99%（誤認識率 → 1-5%）

## ⑤ 改善後の検証計画

### 5.1 検証方法

#### フェーズ 1: 単体テスト（各施策実装後）

- 最初の 10 フレームでのタイムスタンプ抽出精度を測定
- **最後の 10 フレームでのタイムスタンプ抽出精度を測定（新規）**
- 日付誤認識の発生率を記録
- 時系列補正の妥当性を検証

#### フェーズ 2: 統合テスト（P0 施策完了後）

- 実際の動画（`input/merged_moviefiles.mov`）で全フレームを処理
- Ground Truth（`output/labels/result_fixed.json`）と比較
- 認識率、誤認識率、外れ値検知率を測定

#### フェーズ 3: 回帰テスト（全施策完了後）

- 過去の失敗ケースを再実行
- 改善前後の比較（McNemar 検定）
- パフォーマンス影響の測定（処理時間、メモリ使用量）

### 5.2 検証指標

- **認識率**: 正しいタイムスタンプが抽出されたフレームの割合
- **誤認識率**: 日付または時刻が誤っているフレームの割合
- **外れ値検知率**: 異常なタイムスタンプが検出された割合
- **処理時間**: 1 フレームあたりの処理時間（目標: ≤2 秒）
- **信頼度分布**: 信頼度 0.00 の結果の割合（目標: ≤5%）

### 5.3 検証データ

- **テスト動画**: `input/merged_moviefiles.mov`（23,941 フレーム）
- **Ground Truth**: `output/labels/result_fixed.json`
- **期待結果**:
  - 開始時刻: 2025/08/26 16:04:16
  - 終了時刻: 2025/08/29 13:45:39
  - 動画長: 約 13 分 18 秒（798.03 秒）

### 5.4 成功基準

- **最低基準**: 認識率 ≥ 90%、誤認識率 ≤ 10%
- **目標基準**: 認識率 ≥ 95%、誤認識率 ≤ 5%
- **理想基準**: 認識率 ≥ 98%、誤認識率 ≤ 2%

## ⑥ 現状の分析結果（2025-11-06）

### 6.1 改善効果の確認

**分析ツール**: `tools/video_timestamp_analyzer.py`

**結果サマリー**:

- **最初のフレーム**: ✅ 正しく認識（2025/08/26 16:04:16、信頼度 0.76-0.93）
- **最後のフレーム群**: ❌ 誤認識継続（フレーム 23931-23939: 2025/08/02 09:13:44、信頼度 0.00）
- **最後のフレーム**: ✅ 正しく認識（フレーム 23940: 2025/08/29 13:45:39、信頼度 0.54）

### 6.2 残存する問題

1. **最後のフレーム群での誤認識継続**

   - フレーム 23931-23939 で誤認識（2025/08/02 09:13:44）
   - 信頼度 0.00 の結果が採用されている
   - 時系列補正ロジックが最後のフレーム群で正しく機能していない

2. **信頼度 0.00 の結果の除外不足**

   - 信頼度 0.00 の結果が採用されている
   - 信頼度閾値によるフィルタリングが不足

3. **時系列補正の不完全性**
   - ±7 日以上の差を除外するロジックは実装済み
   - しかし、最後のフレーム群では効果が限定的

### 6.3 次の施策（優先度順）

1. **施策 9: 最後のフレーム検証と再試行メカニズム**（P0、最優先）
2. **施策 10: 信頼度閾値による結果フィルタリング**（P0、高優先度）
3. **施策 11: 時系列補正の改善**（P0、高優先度）

## 実装の詳細

### 主要な変更ファイル

1. `src/timestamp/timestamp_extractor.py`

   - 最初のフレーム検証メソッド追加 ✅
   - 時系列補正ロジックの厳格化 ✅
   - 日付独立検証メソッド追加 ✅
   - **最後のフレーム検証メソッド追加（新規）**
   - **信頼度フィルタリング追加（新規）**

2. `src/timestamp/ocr_engines.py`

   - アンサンブル機能の強化 ✅

3. `src/video/frame_sampler.py`

   - 外れ値検知の強化 ✅
   - **最後のフレーム検証の統合（新規）**

4. `src/detection/preprocessing.py`
   - 適応的前処理の追加 ✅

### 設定ファイルの変更

- `config.yaml`: 新規パラメータの追加
  - `timestamp.extraction.initial_frame_validation` ✅
  - `timestamp.extraction.strict_temporal_correction` ✅
  - `timestamp.extraction.date_independent_verification` ✅
  - `timestamp.extraction.final_frame_validation`（新規）
  - `timestamp.extraction.confidence_threshold`（新規）
