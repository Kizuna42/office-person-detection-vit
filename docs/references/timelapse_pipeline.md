# タイムラプス処理パラメータガイド

## 📋 最終更新
2025年11月7日

## 🎯 目的
タイムラプス動画の特性（時間圧縮率約313.4倍）に対応するため、時系列検証と信頼度閾値を最適化する。

---

## ⚙️ 設定変更内容

### 1. TemporalValidatorV2の有効化

**変更前**:
```yaml
use_improved_validator: false
```

**変更後**:
```yaml
use_improved_validator: true
```

**理由**:
- タイムラプス動画の特性（時間圧縮率約313.4倍）に対応するため
- 適応的許容範囲と異常値リカバリー機能により、タイムラプス動画の変動に対応

### 2. 信頼度閾値の調整

**変更前**:
```yaml
confidence_threshold: 0.7
```

**変更後**:
```yaml
confidence_threshold: 0.5
```

**理由**:
- タイムラプス動画ではOCR信頼度が0.49-0.50程度になることがある
- 0.70の閾値では多くのフレームが除外されてしまう
- 0.5に調整することで、より多くのフレームを抽出可能に

### 3. TemporalValidatorV2のベース許容範囲調整

**変更前**:
```yaml
validator:
  base_tolerance_seconds: 10.0
  z_score_threshold: 2.0
```

**変更後**:
```yaml
validator:
  base_tolerance_seconds: 300.0
  z_score_threshold: 3.0
```

**理由**:
- タイムラプス動画では、5分間隔のフレーム抽出の場合、実際の時間差は300秒（5分）
- 動画上のフレーム差は約1秒（30fpsの場合）
- 時系列検証では実際の時間差を検証するため、300秒程度の許容範囲が必要
- Z-score閾値を3.0に緩和することで、タイムラプス動画の変動に対応

---

## 📊 タイムラプス動画の特性

### 時間圧縮率
- **約313.4倍**: 動画の1秒 = 実際の約313秒（約5.2分）
- **1フレーム**: 実際の約10.4秒（30fpsの場合）

### フレーム抽出の特性
- **5分間隔のフレーム抽出**: 実際の時間差は300秒（5分）
- **動画上のフレーム差**: 約1秒（30fpsの場合）
- **許容誤差**: ±10秒（実際の時間）

### 時系列検証の課題
- タイムラプス動画では、期待される時間差と実際の時間差が大きく異なる
- 例: `expected=1.0s, actual=299.0s` (約5分の差)
- 従来の固定許容範囲（10秒）では対応できない

---

## 🔧 TemporalValidatorV2の機能

### 適応的許容範囲
- 過去N個のフレーム間隔から動的に許容範囲を計算
- 標準偏差の1.5倍をベース許容範囲に加算
- タイムラプス動画の変動に対応

### 異常値リカバリー
- Z-score法による外れ値検出
- 前後フレームからの線形補間によるタイムスタンプ補正
- タイムラプス動画の特性を考慮したリカバリー

---

## 📈 期待される効果

### 1. 時系列検証エラーの削減
- タイムラプス動画の特性に対応した適応的許容範囲により、エラーを削減
- 異常値リカバリーにより、一部のエラーを自動修正

### 2. 抽出成功率の向上
- 信頼度閾値を0.5に調整することで、より多くのフレームを抽出可能
- 0.49-0.50の信頼度でも受け入れることで、抽出成功率が向上

### 3. 精度の維持
- TemporalValidatorV2の適応的許容範囲により、精度を維持しながらエラーを削減
- 異常値リカバリーにより、一部のエラーを自動修正

---

## ⚠️ 注意事項

### 1. ベース許容範囲の調整
- 現在の設定（300秒）は5分間隔のフレーム抽出を想定
- 異なる間隔の場合は、適切に調整が必要

### 2. 信頼度閾値の調整
- 0.5に調整することで、より多くのフレームを抽出可能
- ただし、精度が低下する可能性もあるため、実際の結果を確認する必要がある

### 3. Z-score閾値の調整
- 3.0に緩和することで、タイムラプス動画の変動に対応
- ただし、異常値検出が緩くなる可能性もあるため、実際の結果を確認する必要がある

---

## 🧪 検証方法

### 1. 実行テスト
```bash
# タイムスタンプOCRのみ実行（短時間）
python main.py --timestamps-only --start-time "16:05" --end-time "16:10" --debug
```

### 2. 確認事項
- 時系列検証エラーが削減されているか
- 抽出成功率が向上しているか
- 精度が維持されているか

### 3. ログ確認
- `output/system.log`で時系列検証の結果を確認
- 異常値リカバリーが動作しているか確認

---

## 📝 関連ドキュメント

- [Phase1~Phase3 実装状況 俯瞰評価レポート](phase1-3_evaluation_report.md)
- [Phase1~Phase3 実行結果レポート](phase1-3_execution_report.md)
- [改善機能の統合とテストガイド](improved_features_integration.md)
- [Phase 3: 精度改善 - 詳細実装状況検証レポート](phase3_detailed_verification.md)

---

## 🔄 設定の元に戻す方法

設定を元に戻す場合は、以下のように変更します：

```yaml
timestamp:
  extraction:
    confidence_threshold: 0.7
    use_improved_validator: false
    validator:
      base_tolerance_seconds: 10.0
      z_score_threshold: 2.0
```

ただし、タイムラプス動画では時系列検証エラーが発生する可能性があります。
