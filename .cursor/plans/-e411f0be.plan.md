<!-- e411f0be-f842-48c0-86f6-bbf41f03003e 1f756806-5edd-48a2-9daa-c1f3dd9f86e2 -->
# オブジェクト追跡と座標変換改善 - 実装戦略（品質保証付き）

## タスク1: オブジェクト追跡可視化（軌跡線 + ID表示）

### 1.1 追跡アルゴリズムの実装

**推奨アプローチ**: DeepSORTベースの実装（DETR特徴量活用）

**実装ファイル**:

- `src/tracking/tracker.py` (新規)
- `src/tracking/deep_sort.py` (新規)
- `src/tracking/feature_extractor.py` (新規)

**技術選択**:

- **特徴量抽出**: DETRモデルのencoder出力から特徴量を抽出（`model.encoder`の最終層）
- **追跡アルゴリズム**: DeepSORT（Kalman Filter + Hungarian Algorithm）
- **距離メトリクス**: コサイン距離（外観特徴量）+ IoU距離（位置情報）の組み合わせ

**実装ステップ**:

1. DETRモデルから特徴量抽出機能を追加（`ViTDetector`に`extract_features()`メソッド追加）
2. `Tracker`クラス実装（フレーム間のID割り当て）
3. `Detection`データモデルに`track_id`フィールド追加
4. 軌跡データ構造`Trajectory`クラス作成（時系列の位置情報を保持）

**目視確認タスク**:

- 追跡結果の可視化確認（IDの一貫性、軌跡の連続性）
- 誤追跡（IDスイッチ）の発生率確認
- サンプル動画での追跡精度の目視評価
- 複数人物が同時に存在する場合の追跡精度確認

### 1.2 可視化機能の拡張

**実装ファイル**: `src/visualization/floormap_visualizer.py` (拡張)

**追加機能**:

- 軌跡線の描画（時系列で色をグラデーション）
- IDラベルの表示（各検出に一意のIDを表示）
- 軌跡のアニメーション（時間経過に伴う移動の可視化）

**可視化オプション**:

- 軌跡の長さ制限（最新Nフレームのみ表示）
- IDの色分け（ゾーンごと、またはランダム）
- 軌跡の透明度（古い軌跡ほど薄く）

**目視確認タスク**:

- 軌跡線が正しく描画されているか
- IDラベルの可読性確認（フォントサイズ、位置）
- 軌跡の色分けが適切か
- 複数軌跡が重なった場合の可視性

---

## タスク2: 座標変換の改善（精度向上 + カメラ内部パラメータ）

### 2.1 カメラキャリブレーション機能の追加

**実装ファイル**:

- `src/calibration/camera_calibrator.py` (新規)
- `src/transform/coordinate_transformer.py` (拡張)

**追加パラメータ**:

```yaml
camera:
  # 既存
  position_x: 859
  position_y: 1040
  height_m: 2.2

  # 新規追加
  intrinsics:
    focal_length_x: 800.0  # ピクセル単位
    focal_length_y: 800.0
    principal_point_x: 640.0  # 画像中心
    principal_point_y: 360.0
    image_width: 1280
    image_height: 720

  distortion:
    k1: 0.0  # 放射歪み係数
    k2: 0.0
    k3: 0.0
    p1: 0.0  # 接線歪み係数
    p2: 0.0
```

**目視確認タスク**:

- チェスボード検出精度の確認（検出されたコーナーの可視化）
- キャリブレーション結果の可視化（再投影誤差の分布）
- 対応点の配置確認（画像全体に均等分布しているか）

### 2.2 精度向上のための改善策

**A. 歪み補正の実装**

- OpenCVの`cv2.undistort()`を使用して画像の歪みを補正
- 補正後の画像で検出を実行し、より正確な座標変換を実現

**B. ホモグラフィ行列の最適化**

- RANSACによる外れ値除去の強化
- 対応点の数を増やす（現在4点以上 → 8点以上推奨）
- 対応点の配置最適化（画像全体に均等に分布）

**C. 再投影誤差の評価とフィードバック**

- 変換精度の評価機能を追加
- 誤差が大きい領域を可視化
- キャリブレーション品質レポート生成

**D. 多段階変換の実装**

1. カメラ座標 → 歪み補正座標
2. 歪み補正座標 → 正規化座標
3. 正規化座標 → フロアマップ座標（ホモグラフィ）

**精度向上のアドバイス**:

1. **対応点の品質向上**: 床面の明確な特徴点（コーナー、マーカー）を使用
2. **カメラ内部パラメータの正確な測定**: チェスボードキャリブレーション推奨
3. **ホモグラフィ行列の定期再計算**: カメラ位置変更時に再キャリブレーション
4. **高さ補正**: 人物の高さを考慮した補正（現在は足元のみ）

**目視確認タスク**:

- 歪み補正前後の画像比較（歪みが正しく補正されているか）
- 再投影誤差マップの確認（誤差が許容範囲内か）
- 変換後の座標がフロアマップ範囲内か
- 対応点の配置が適切か（画像全体に均等分布）

### 2.3 実装ステップ

1. `CameraCalibrator`クラス実装（チェスボードキャリブレーション対応）
2. `CoordinateTransformer`に歪み補正機能追加
3. 設定ファイルにカメラ内部パラメータ追加
4. 変換精度評価モジュール追加

---

## タスク3: 同一オブジェクトの類似度計算（推奨実装）

### 3.1 特徴量抽出の実装

**推奨アプローチ**: DETRエンコーダーの特徴量を活用

**実装ファイル**: `src/detection/vit_detector.py` (拡張)

**特徴量抽出方法**:

```python
def extract_features(self, frame: np.ndarray, detections: list[Detection]) -> np.ndarray:
    """検出結果に対応する特徴量を抽出

    DETRエンコーダーの最終層の特徴量を使用
  - 各検出バウンディングボックス領域の特徴量を抽出
  - L2正規化を適用（コサイン類似度計算のため）
    """
```

**技術詳細**:

- DETRの`encoder.last_hidden_state`からROI特徴量を抽出
- ROI AlignまたはROI Poolingで固定サイズ特徴量に変換
- 特徴量次元: 256次元（DETR-ResNet-50の場合）

**目視確認タスク**:

- 特徴量抽出結果の可視化（t-SNE等で次元削減して確認）
- 同一人物の特徴量が類似しているか確認
- 異なる人物の特徴量が区別できているか確認

### 3.2 類似度計算モジュール

**実装ファイル**: `src/tracking/similarity.py` (新規)

**類似度メトリクス**:

1. **コサイン類似度**（外観特徴量）: `cosine_similarity(feat1, feat2)`
2. **IoU距離**（位置情報）: `1 - iou(bbox1, bbox2)`
3. **統合距離**: `α * cosine_distance + β * iou_distance`

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - α=0.7, β=0.3（外観重視）

**実装クラス**:

- `FeatureExtractor`: 特徴量抽出
- `SimilarityCalculator`: 類似度計算
- `ReIDMatcher`: 再識別マッチング

**目視確認タスク**:

- 同一人物の類似度が高いか（コサイン類似度 > 0.8）
- 異なる人物の類似度が低いか（コサイン類似度 < 0.5）
- 特徴量の可視化（t-SNE等）でクラスタリングが適切か

### 3.3 Detectionデータモデルの拡張

**変更ファイル**: `src/models/data_models.py`

**追加フィールド**:

```python
@dataclass
class Detection:
    # 既存フィールド...
    track_id: Optional[int] = None  # 追跡ID
    features: Optional[np.ndarray] = None  # 外観特徴量 (256次元)
    appearance_score: Optional[float] = None  # 外観マッチングスコア
```

---

## タスク4: インタラクティブ可視化ツール

### 4.1 Webベース可視化ツールの実装

**推奨技術**: StreamlitまたはPlotly Dash

**実装ファイル**:

- `tools/interactive_visualizer.py` (新規)
- `tools/visualizer_app.py` (新規、Streamlitアプリ)

**機能要件**:

1. **セッション選択**: 過去の実行結果を選択
2. **時間軸スライダー**: フレーム間を移動
3. **軌跡表示のON/OFF**: 軌跡線の表示切り替え
4. **IDフィルタリング**: 特定のIDのみ表示
5. **ゾーン別フィルタリング**: 特定ゾーンのみ表示
6. **統計情報パネル**: リアルタイム統計表示
7. **エクスポート機能**: 画像・動画・CSV出力

**UI構成**:

- 左パネル: コントロール（スライダー、フィルタ、設定）
- 中央: フロアマップ可視化（PlotlyまたはOpenCV）
- 右パネル: 統計情報・メタデータ

**目視確認タスク**:

- UIの操作性確認
- リアルタイム更新の動作確認
- エクスポート機能の動作確認
- パフォーマンス確認（レスポンス速度）

### 4.2 データエクスポート機能

**実装ファイル**: `src/utils/export_utils.py` (新規)

**出力形式**:

- **動画**: MP4形式（軌跡アニメーション）
- **画像シーケンス**: PNG形式（各フレーム）
- **CSV**: 軌跡データ（ID, timestamp, x, y, zone）
- **JSON**: 完全な追跡データ

### 4.3 目視確認用ツール

**実装ファイル**: `tools/visual_inspection.py` (新規)

**機能**:

- キャリブレーション結果の可視化
- 追跡結果の可視化（動画形式）
- 座標変換精度の可視化（誤差マップ）
- インタラクティブな確認ツール

**使用方法**:

```bash
# キャリブレーション結果確認
python tools/visual_inspection.py --mode calibration --session <session_id>

# 追跡結果確認
python tools/visual_inspection.py --mode tracking --session <session_id>

# 座標変換精度確認
python tools/visual_inspection.py --mode reprojection --session <session_id>
```

---

## 実装順序と依存関係

### Phase 1: 基盤実装（1-2週間）

1. 特徴量抽出機能の追加（`ViTDetector`拡張）
2. `Detection`データモデルの拡張（`track_id`, `features`追加）
3. カメラキャリブレーション機能の追加

**目視確認タスク**:

- キャリブレーション結果の可視化確認（チェスボード検出精度）
- 特徴量抽出結果の可視化（t-SNE等で次元削減して確認）

### Phase 2: 追跡機能実装（1-2週間）

1. `Tracker`クラス実装
2. `SimilarityCalculator`実装
3. 追跡アルゴリズムの統合

**目視確認タスク**:

- 追跡結果の可視化確認（IDの一貫性、軌跡の連続性）
- 誤追跡（IDスイッチ）の発生率確認
- サンプル動画での追跡精度の目視評価

### Phase 3: 可視化拡張（1週間）

1. `FloormapVisualizer`に軌跡描画機能追加
2. ID表示機能追加
3. インタラクティブツールの実装

**目視確認タスク**:

- 軌跡線の可視性確認（色、太さ、透明度）
- IDラベルの可読性確認（フォントサイズ、位置）
- インタラクティブツールのUI/UX確認

### Phase 4: 座標変換改善（1週間）

1. 歪み補正機能追加
2. 変換精度評価機能追加
3. キャリブレーションツールの改善

**目視確認タスク**:

- 歪み補正前後の画像比較
- 再投影誤差の可視化確認（誤差マップ）
- 変換精度レポートの確認

---

## 品質保証プロセス

### 各タスクの実装フロー

1. **実装**

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - 機能実装
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - ユニットテスト作成
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - 統合テスト作成

2. **ローカル品質チェック**

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - `make lint`: ruff, mypyチェック
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - `make format`: コードフォーマット
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - `make test`: 全テスト実行（カバレッジ80%以上）
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - `make type-check`: 型チェック

3. **目視確認**

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - 可視化結果の確認
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - サンプルデータでの動作確認
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - 精度評価レポートの確認

4. **Git管理**

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - 機能ブランチ作成: `feature/task-name`
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - コミット: Conventional Commits形式
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - プッシュ前にpre-commitフック実行

5. **CI/CDチェック**

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - GitHub Actionsで自動実行:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Lintチェック（ruff, mypy）
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - フォーマットチェック（ruff-format）
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - テスト実行（pytest --cov）
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - 型チェック（mypy）
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - 全チェック通過後にマージ可能

6. **精度評価**

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - MOTメトリクス計算（追跡タスク）
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - 再投影誤差評価（座標変換タスク）
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - ベンチマークテスト実行

7. **レビュー & マージ**

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - コードレビュー
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - 精度評価レポート確認
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - 目視確認結果のスクリーンショット添付
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - マージ承認

### CI/CD設定の拡張

**`.github/workflows/ci.yml`への追加**:

```yaml
name: CI

on: [push, pull_request]

jobs:
  quality-check:
    runs-on: ubuntu-latest
    steps:
   - uses: actions/checkout@v3
   - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
   - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install ruff mypy pytest pytest-cov
   - name: Lint
        run: ruff check src/ tests/
   - name: Format check
        run: ruff format --check src/ tests/
   - name: Type check
        run: mypy src/
   - name: Test
        run: pytest --cov=src --cov-report=xml --cov-fail-under=80 tests/
   - name: Upload coverage
        uses: codecov/codecov-action@v3
```

### Git管理ベストプラクティス

**ブランチ戦略**:

- 各タスクごとに機能ブランチ作成
- 命名規則: `feature/tracking-visualization`, `feature/coordinate-improvement`等

**コミット規約**:

- `feat(tracking): 特徴量抽出機能を追加`
- `fix(transform): 歪み補正のバグ修正`
- `test(tracking): 追跡アルゴリズムのテスト追加`

**プルリクエスト**:

- 各タスク完了後にPR作成
- CIチェック通過必須
- 精度評価レポート添付
- 目視確認結果のスクリーンショット添付

---

## 設定ファイルの拡張

**config.yamlへの追加**:

```yaml
tracking:
  enabled: true
  algorithm: "deepsort"  # "deepsort" or "simple_iou"
  max_age: 30  # フレーム数（IDが消失してから削除するまでの時間）
  min_hits: 3  # 追跡確立に必要な最小検出回数
  iou_threshold: 0.3
  appearance_weight: 0.7  # 外観特徴量の重み
  motion_weight: 0.3  # 位置情報の重み

calibration:
  use_distortion_correction: true
  use_intrinsics: true
  reprojection_error_threshold: 2.0  # ピクセル単位
```

---

## テスト戦略

1. **ユニットテスト**: 各モジュールの個別テスト

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - カバレッジ80%以上必須
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - エッジケースのテスト含む

2. **統合テスト**: 追跡パイプライン全体のテスト

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - エンドツーエンドのテスト
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - サンプルデータでの動作確認

3. **精度評価**: MOT（Multiple Object Tracking）メトリクスで評価

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - MOTA (Multiple Object Tracking Accuracy) ≥ 0.7目標
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - IDF1 (ID F1 Score) ≥ 0.8目標
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - 軌跡の連続性評価
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - IDスイッチ数の評価

4. **ベンチマークテスト**: パフォーマンス評価

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - 処理時間の測定
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - メモリ使用量の測定
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - ボトルネック分析

5. **回帰テスト**: 既存機能への影響確認

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - 既存テストスイートの全通過必須
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - 後方互換性の確認

---

## 品質ゲート

各タスクは以下の条件を満たす必要があります：

1. **コード品質**

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Lintエラー: 0件
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - 型チェックエラー: 0件（既存コードのエラーは別途対応）
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - テストカバレッジ: ≥80%

2. **機能品質**

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - 全ユニットテスト通過
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - 全統合テスト通過
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - 目視確認チェックリスト完了

3. **精度品質**

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - MOTA ≥ 0.7（追跡タスク）
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - 再投影誤差 ≤ 2.0ピクセル（座標変換タスク）
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - 特徴量類似度の閾値適切性確認

4. **パフォーマンス品質**

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - 処理時間が既存実装の2倍以内
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - メモリ使用量が既存実装の1.5倍以内

---

## 目視確認チェックリスト

### タスク1: オブジェクト追跡可視化

- [ ] 軌跡線が正しく描画されているか
- [ ] IDが一貫して割り当てられているか（IDスイッチの確認）
- [ ] 軌跡の色分けが適切か
- [ ] IDラベルの可読性
- [ ] 複数人物が同時に存在する場合の追跡精度

### タスク2: 座標変換改善

- [ ] 歪み補正前後の画像比較（歪みが正しく補正されているか）
- [ ] 再投影誤差マップの確認（誤差が許容範囲内か）
- [ ] 変換後の座標がフロアマップ範囲内か
- [ ] 対応点の配置が適切か（画像全体に均等分布）

### タスク3: 類似度計算

- [ ] 同一人物の類似度が高いか（コサイン類似度 > 0.8）
- [ ] 異なる人物の類似度が低いか（コサイン類似度 < 0.5）
- [ ] 特徴量の可視化（t-SNE等）でクラスタリングが適切か

### タスク4: インタラクティブ可視化

- [ ] UIの操作性
- [ ] リアルタイム更新の動作
- [ ] エクスポート機能の動作確認
- [ ] パフォーマンス（レスポンス速度）

---

## パフォーマンス考慮事項

1. **特徴量抽出の最適化**: バッチ処理で効率化
2. **追跡アルゴリズムの高速化**: 距離計算のベクトル化
3. **メモリ管理**: 古い軌跡データの適切な削除
4. **可視化の最適化**: 大量の軌跡描画時のパフォーマンス対策

### To-dos

- [ ] DETRモデルから特徴量抽出機能を実装（ViTDetectorにextract_features()メソッド追加）
- [ ] Detectionデータモデルにtrack_idとfeaturesフィールドを追加
- [ ] 類似度計算モジュールを実装（コサイン類似度、IoU距離、統合距離）
- [ ] DeepSORTベースのTrackerクラスを実装（Kalman Filter + Hungarian Algorithm）
- [ ] FloormapVisualizerに軌跡線描画とID表示機能を追加
- [ ] カメラキャリブレーション機能を実装（内部パラメータ、歪み係数の取得）
- [ ] 座標変換に歪み補正機能を追加（cv2.undistort使用）
- [ ] 再投影誤差の評価機能を実装（変換精度の定量評価）
- [ ] Streamlitベースのインタラクティブ可視化ツールを実装
- [ ] 軌跡データのエクスポート機能を実装（動画、画像、CSV、JSON）
- [ ] 目視確認用ツールを実装（visual_inspection.py）
- [ ] CI/CDパイプラインを拡張（lint, format, test, type-checkの自動実行）
- [ ] 追跡機能のユニットテストを作成（カバレッジ80%以上）
- [ ] 統合テストを作成（エンドツーエンドのテスト）
- [ ] 精度評価モジュールを実装（MOTメトリクス、再投影誤差評価）
