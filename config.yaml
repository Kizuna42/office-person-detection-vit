# オフィス人物検出システム設定ファイル
# Office Person Detection System Configuration File

# ==============================================================================
# 1. 入力設定 (Input)
# ==============================================================================
video:
  # 入力動画ファイルのパス
  input_path: "input/merged_moviefiles.mov"
  # タイムラプス動画かどうか
  is_timelapse: true
  # フレーム抽出間隔（分）- 最終出力用キーフレーム
  frame_interval_minutes: 5
  # タイムスタンプ許容誤差（秒）
  tolerance_seconds: 30
  # 範囲限定スキャン時のマージン時間（分）
  scan_margin_minutes: 5
  # フレームレート（fps）
  fps: 30
  # 実時間 / 動画時間 の圧縮倍率（タイムラプスの場合 >1）
  time_compression_ratio: 313.0

  # 高密度トラッキング設定（Phase 2）
  dense_tracking:
    enabled: true  # 10秒間隔フレームを使用した連続トラッキング
    tracking_interval_seconds: 10  # トラッキング用フレーム間隔（秒）
    output_interval_minutes: 5  # 最終出力間隔（分）

# ==============================================================================
# 2. 検出設定 (Detection - Phase 2)
# ==============================================================================
detection:
  # 検出器タイプ: "yolov8" (推奨) または "detr"
  detector_type: "yolov8"

  # YOLOv8設定（detector_type="yolov8"時）
  yolov8_model_path: "runs/detect/person_ft/weights/best.pt"

  # DETR設定（detector_type="detr"時）
  model_name: "facebook/detr-resnet-50"

  # 検出信頼度閾値（0.0-1.0）
  # YOLOv8 Fine-tuned: 0.25推奨（F1=0.831）
  # DETR: 0.70推奨
  confidence_threshold: 0.25

  # NMS/IoU閾値（0.0-1.0）
  iou_threshold: 0.45

  # パッチサイズ（DETR用）
  patch_size: 16

  # 使用デバイス ("mps", "cuda", "cpu")
  device: "mps"

  # バッチサイズ（複数フレームの同時処理数）
  batch_size: 4

# ==============================================================================
# 3. 追跡設定 (Tracking - Phase 2.5)
# ==============================================================================
tracking:
  # 追跡機能を有効にするか
  enabled: true
  # 追跡アルゴリズム ("deepsort" 推奨)
  algorithm: "deepsort"
  # IDが消失してから削除するまでの最大フレーム数
  # Phase1改善: 5分間隔×長時間対応で100に拡大
  max_age: 100
  # 追跡確立に必要な最小検出回数
  # 低頻度検出対応: 2→1に引き下げ
  min_hits: 1
  # IoU閾値（マッチング用）
  iou_threshold: 0.5
  # 外観特徴量の重み（0.0-1.0）
  # Phase1改善: 5分間隔では位置が信頼できないため外観重視（0.3→0.9）
  appearance_weight: 0.9
  # 位置情報の重み（0.0-1.0）
  # Phase1改善: 位置依存を最小化（0.7→0.1）
  motion_weight: 0.1
  # 位置距離の最大許容値（ピクセル）
  # Phase1改善: 5分間隔では位置制約を事実上無効化（300→10000）
  max_position_distance: 10000.0
  # ハイブリッドモード: 検出フレーム間をOptical Flow/Kalmanで補間
  hybrid_mode:
    enabled: true  # true: LightweightTracker使用, false: DeepSORTのみ
    use_optical_flow: true  # Optical Flowを使用するか（falseならKalman予測のみ）

  # Phase2: Re-ID特化特徴抽出（長時間サンプリング対応）
  reid:
    enabled: true  # true: Re-ID特徴量を使用, false: DETR特徴量を使用
    model_type: "osnet"  # "clip" | "osnet" - OSNet推奨（精度+12%）
    model_name: "openai/clip-vit-base-patch32"  # CLIPモデル（model_type="clip"時）
    model_path: "models/osnet_x1_0_market1501.pth"  # OSNetモデルパス（オプション、nullならpretrained使用）
    # feature_dim: 512 (自動設定)
# ==============================================================================
# 4. 座標変換設定 (Transform - Phase 3)
# ==============================================================================
# 変換方式: "piecewise_affine" (最高精度) / "homography" (2D→2D) / "thin_plate_spline" (TPS)
transform:
  method: "piecewise_affine" # "piecewise_affine" 推奨（RMSE 0px on training data）
  model_path: "output/calibration/pwa_model.pkl"

  # レンズ歪み補正（PWA/TPS変換時のみ有効）
  # チェスボードキャリブレーションで取得した歪み係数を設定
  lens_distortion:
    enabled: false # true にすると歪み補正を適用
    # 放射歪み係数（バレル歪み: k1<0、ピンクッション歪み: k1>0）
    k1: 0.0
    k2: 0.0
    k3: 0.0
    # 接線歪み係数
    p1: 0.0
    p2: 0.0
    # カメラ内部パラメータ（camera_paramsと同期）
    focal_length_x: 1250.0
    focal_length_y: 1250.0
    center_x: 640.0
    center_y: 360.0
    image_width: 1280
    image_height: 720

# ホモグラフィ行列（カメラ座標→フロアマップ座標への直接変換）
# フィルタリング済み8点から推定、RMSE=1.72px
homography:
  matrix:
    - [-0.8795888447, -2.8974379541, 417.8510123786]
    - [-1.5459702925, -3.4570021203, 1054.0107447082]
    - [-0.0011928509, -0.0035480452, 1.0000000000]

# ピンホールカメラモデル（バックアップ/将来使用）
camera_params:
  # --- 外部パラメータ (Extrinsics) ---
  # カメラ設置高さ（メートル）
  height_m: 2.2

  # 俯角（度）: 0=水平, 正=下向き
  # カメラが床を見下ろす角度。例: 45度
  pitch_deg: 12.0

  # 方位角（度）: 0=前方(Y+方向)、正=右回転
  yaw_deg: 20.0

  # 回転角（度）: 0=水平
  roll_deg: 0.0

  # カメラ位置（World座標系）[メートル]
  # カメラ直下を原点とする相対位置
  camera_x_m: 0.0
  camera_y_m: 0.0

  # --- カメラ位置（フロアマップ座標系）[ピクセル] ---
  # フロアマップ上でカメラがどこにあるか
  position_x_px: 859.0
  position_y_px: 1040.0

  # --- 内部パラメータ (Intrinsics) ---
  # 焦点距離（ピクセル）
  # 推定式: f_pixel = (image_width / 2) / tan(FOV / 2)
  focal_length_x: 1250.0
  focal_length_y: 1250.0

  # 画像中心（ピクセル）
  center_x: 640.0
  center_y: 360.0

  # 入力画像サイズ
  image_width: 1280
  image_height: 720

  # 歪み係数 (Distortion Coefficients)
  # [k1, k2, p1, p2, k3]
  # 魚眼レンズや広角レンズの場合に設定
  dist_coeffs: [0.0, 0.0, 0.0, 0.0, 0.0]

# カメラ表示設定（フロアマップ上でのカメラアイコン表示用）
camera:
  position_x: 859
  position_y: 1040
  height_m: 2.2
  show_on_floormap: true
  marker_color: [0, 0, 255]
  marker_size: 15

# キャリブレーション設定
calibration:
  # キャリブレーションモード: "auto" | "manual" | "hybrid"
  mode: "hybrid"
  # 対応点ファイルのパス
  correspondence_file: "output/calibration/correspondence_points_new.json"
  # 歪み補正を使用するか
  use_distortion_correction: false
  # 内部パラメータを使用するか
  use_intrinsics: true
  # 再投影誤差の閾値 [pixels]
  reprojection_error_threshold: 10.0
  # 内部パラメータ（camera_paramsと同期）
  intrinsics:
    focal_length_x: 1250.0
    focal_length_y: 1250.0
    principal_point_x: 640.0
    principal_point_y: 360.0
    image_width: 1280
    image_height: 720
  # 歪み係数
  distortion:
    k1: 0.0
    k2: 0.0
    k3: 0.0
    p1: 0.0
    p2: 0.0
  # 最適化設定
  optimization:
    max_iterations: 100
    tolerance: 1.0e-6

# フロアマップ設定
floormap:
  # フロアマップ画像のパス
  image_path: "data/floormap.png"

  # 画像サイズ（ピクセル）
  image_width: 1878
  image_height: 1369

  # 原点オフセット（ピクセル）: 固定値（フロアマップ仕様）
  # 注意: これらの値は固定値であり、カメラ位置とは異なります
  image_origin_x: 7
  image_origin_y: 9

  # スケール（mm/pixel）: 1ピクセルが何mmに相当するか（固定値、精度重要）
  image_x_mm_per_pixel: 28.1926406926406
  image_y_mm_per_pixel: 28.241430700447

# ゾーン定義
zones:
  - id: "zone_1"
    name: "ゾーン1（左）"
    polygon: [[859, 912], [1095, 912], [1095, 1350], [859, 1350]]
    priority: 1
  - id: "zone_2"
    name: "ゾーン2（中央）"
    polygon: [[1095, 912], [1331, 912], [1331, 1350], [1095, 1350]]
    priority: 2
  - id: "zone_3"
    name: "ゾーン3（右）"
    polygon: [[1331, 912], [1567, 912], [1567, 1350], [1331, 1350]]
    priority: 3

# ==============================================================================
# 5. 出力設定 (Output)
# ==============================================================================
output:
  directory: "output"
  use_session_management: true
  save_detection_images: true
  save_tracking_images: true
  save_floormap_images: true
  save_side_by_side_video: true
  side_by_side_video_fps: 1.0
  debug_mode: false
  # 一時ファイルの自動削除設定
  cleanup_temp_files: true # パイプライン完了時に_temp_framesを削除
  # JSON出力最適化設定
  json_optimization:
    enabled: true # 最適化を有効化
    coordinate_precision: 1 # 座標の小数点以下桁数（1=小数第1位）
    compact_keys: true # キー名を短縮（bbox→bb, confidence→conf等）
    exclude_px_coords: true # floor_coords_pxを除外（mmのみ出力）
  session:
    archive_days: 30
    delete_archive_days: 90

# ==============================================================================
# 6. その他設定 (Timestamp, OCR, Evaluation)
# ==============================================================================
timestamp:
  extraction:
    confidence_threshold: 0.5
    retry_count: 3
    use_improved_validator: true
    validator:
      base_tolerance_seconds: 30.0
      history_size: 10
      z_score_threshold: 3.0
    roi:
      x_ratio: 0.70
      y_ratio: 0.045
      width_ratio: 0.28
      height_ratio: 0.06
  extraction_mode: "auto_targets"
  auto_targets:
    max_frames: 290
    disable_validation: true
  sampling:
    # OCR頻度向上: 10秒→5秒に短縮（時刻同期精度改善）
    coarse_interval_seconds: 5.0
    fine_interval_seconds: 1.0
    search_window_seconds: 30.0

ocr:
  engines: ["tesseract"]
  tesseract:
    config: "--psm 8 --oem 3"
    whitelist: "0123456789/:  "

evaluation:
  ground_truth_path: "output/labels/result_fixed.json"
  iou_threshold: 0.5
