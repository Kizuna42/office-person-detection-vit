# 次のステップ - 完全タスクリスト

## 🔴 Phase 1: 検証・テスト（最優先）

### 1.1 単体テストの実装

- [x] **`tests/test_roi_extractor.py`** 作成
  - [x] ROI 抽出位置の正確性テスト
  - [x] 前処理パイプラインのテスト（各段階の出力確認）
  - [x] エッジケース（極端に暗い/明るいフレーム）のテスト
- [x] **`tests/test_timestamp_parser.py`** 作成
  - [x] 正常系パーステスト（標準フォーマット）
  - [x] fuzzy_parse 誤認識補正テスト
  - [x] 異常系テスト（不正な文字列）
  - [x] 境界値テスト（2 月 29 日、うるう秒など）
- [x] **`tests/test_ocr_engine.py`** 作成
  - [x] 各 OCR エンジンの個別テスト
  - [x] コンセンサスアルゴリズムのテスト
  - [x] 信頼度計算の妥当性テスト
  - [x] 類似度計算のテスト
- [x] **`tests/test_timestamp_validator.py`** 作成
  - [x] 時系列整合性チェックのテスト
  - [x] フレームレート変動への対応テスト
  - [x] リセット機能のテスト
- [x] **`tests/test_frame_sampler.py`** 作成
  - [x] CoarseSampler のフレーム間隔テスト
  - [x] FineSampler の探索範囲テスト
  - [x] AdaptiveSampler の間隔調整ロジックテスト

### 1.2 統合テストの実装

- [x] **`tests/test_timestamp_extractor_v2.py`** 作成
  - [x] エンドツーエンド抽出テスト
  - [x] リトライメカニズムのテスト
  - [x] 信頼度閾値の動作テスト
- [x] **`tests/test_frame_extraction_pipeline.py`** 作成
  - [x] 5 分刻み抽出の正確性テスト
  - [x] ±10 秒許容誤差の検証
  - [x] CSV 出力フォーマットのテスト
  - [x] 欠損データのハンドリングテスト

### 1.3 テストデータ準備

- [x] **短尺サンプル動画の作成**
  - [x] 5 分間のテスト動画（タイムスタンプ付き） - ディレクトリ構造作成済み
  - [x] 品質バリエーション（通常/暗い/ぼやけ） - README に記載
  - [x] 正解データ（Ground Truth）の手動作成 - テンプレート作成済み
- [x] **テストフレーム画像の準備**
  - [x] 10 枚の代表的なフレーム抽出 - ディレクトリ構造作成済み
  - [x] 手動でタイムスタンプをラベリング - テンプレート作成済み
  - [x] `tests/fixtures/` ディレクトリに配置 - 完了

---

## 🟠 Phase 2: 初期評価・デバッグ

### 2.1 実動作確認

- [ ] **サンプル動画での動作確認**

  ```bash
  python main.py --mode extract_frames --video tests/fixtures/sample_5min.mov
  ```

  - [ ] エラーなく完了することを確認
  - [ ] 出力ファイルが生成されることを確認
  - [ ] ログ出力が適切であることを確認

- [ ] **本番動画での試験実行（最初の 1 時間のみ）**
  ```bash
  python main.py --mode extract_frames --duration 3600
  ```
  - [ ] 処理時間の測定
  - [ ] メモリ使用量のモニタリング
  - [ ] エラー発生箇所の特定

### 2.2 精度評価（ベースライン測定）

- [ ] **OCR 精度の測定**
  - [ ] 手動ラベル 100 フレームとの比較
  - [ ] 文字単位の精度計算
  - [ ] エンジン別の精度比較
- [ ] **時系列整合性スコアの測定**
  - [ ] `tools/timestamp_score_evaluator.py` 実行
  - [ ] 現状スコアの記録（ベースライン）
- [ ] **目標時刻との誤差測定**
  - [ ] 各抽出フレームの誤差分布を可視化
  - [ ] ±10 秒以内の達成率を計算

### 2.3 問題の特定とログ分析

- [ ] **失敗ケースの分析**
  - [ ] OCR 失敗フレームの目視確認
  - [ ] 共通パターンの抽出（暗い、ぼやけ、ノイズ等）
  - [ ] 失敗理由の分類とカウント
- [ ] **ログファイルの分析**
  - [ ] WARNING/ERROR レベルのログを抽出
  - [ ] 頻出エラーパターンの特定
  - [ ] ボトルネックの特定（処理時間）

---

## 🟡 Phase 3: 精度改善

### 3.1 ROI 調整

- [ ] **最適な ROI 座標の決定**
  - [ ] 複数フレームで ROI 位置を可視化
  - [ ] タイムスタンプがすべて含まれているか確認
  - [ ] `config.yaml` の ROI 設定を微調整
- [ ] **前処理パラメータのチューニング**
  - [ ] CLAHE の `clipLimit` 調整
  - [ ] 二値化閾値の最適化
  - [ ] ノイズ除去強度の調整
  - [ ] A/B テストで効果測定

### 3.2 OCR エンジンの最適化

- [ ] **Tesseract のパラメータ調整**
  - [ ] `--psm` モードの試行（6, 7, 8, 13）
  - [ ] `tessedit_char_whitelist` の最適化
  - [ ] 言語設定の確認（日本語数字の影響）
- [ ] **EasyOCR 設定の調整**
  - [ ] GPU/CPU モードの性能比較
  - [ ] 言語モデルの選択（'en' vs 'ja'）
  - [ ] 信頼度閾値の調整
- [ ] **PaddleOCR 設定の調整**
  - [ ] `use_angle_cls` の効果検証
  - [ ] 言語設定の確認
  - [ ] 検出モデルのバージョン確認

### 3.3 コンセンサスアルゴリズムの改善

- [ ] **重み付けスキームの導入**
  - [ ] 各エンジンの信頼度に基づく重み付け
  - [ ] エンジン間の一致度を評価指標に追加
- [ ] **投票ロジックの改良**
  - [ ] 2/3 一致ルールの実装
  - [ ] 部分一致（日付のみ、時刻のみ）のハンドリング
- [ ] **フォールバックメカニズムの追加**
  - [ ] 全エンジン失敗時の処理
  - [ ] 近傍フレームからの推定

### 3.4 時系列検証の強化

- [ ] **適応的許容範囲の実装**
  - [ ] 過去 N 個のフレーム間隔から動的に許容範囲を計算
  - [ ] 外れ値検出（Z-score 法）の追加
- [ ] **異常値のリカバリー**
  - [ ] 時系列が大きく外れた場合の補正ロジック
  - [ ] 前後フレームからの線形補間

---

## 🟢 Phase 4: パフォーマンス最適化

### 4.1 並列処理の実装

- [ ] **粗サンプリングの並列化**
  ```python
  from multiprocessing import Pool
  with Pool(processes=4) as pool:
      results = pool.map(process_coarse_frame, frame_indices)
  ```
  - [ ] マルチプロセス対応
  - [ ] 処理速度の測定（改善率）
- [ ] **OCR の並列実行**
  - [ ] 複数エンジンを並列で実行
  - [ ] `concurrent.futures` を使用
  - [ ] デッドロック防止

### 4.2 キャッシング機構

- [ ] **OCR 結果のキャッシュ**
  - [ ] フレームハッシュをキーにキャッシュ
  - [ ] `@lru_cache` デコレータの活用
  - [ ] ディスクキャッシュ（pickle）の実装
- [ ] **前処理結果のキャッシュ**
  - [ ] ROI 抽出結果のキャッシュ
  - [ ] 前処理済み画像のキャッシュ

### 4.3 メモリ最適化

- [ ] **ストリーミング処理**
  - [ ] フレームをメモリに保持しない
  - [ ] ジェネレータパターンの徹底
- [ ] **バッチ処理の最適化**
  - [ ] バッチサイズの調整
  - [ ] メモリ使用量のプロファイリング

### 4.4 GPU 活用

- [ ] **OCR の GPU 加速**
  - [ ] EasyOCR/PaddleOCR の GPU モード有効化
  - [ ] CUDA 利用可能性の確認
- [ ] **前処理の GPU 化（OpenCV-CUDA）**
  - [ ] `cv2.cuda` モジュールの活用
  - [ ] 効果測定

---

## 🔵 Phase 5: ロバスト性向上

### 5.1 エラーハンドリングの強化

- [ ] **例外の詳細な分類**
  - [ ] カスタム例外クラスの定義
  - [ ] 各エラーに対する適切な処理
- [ ] **リトライ戦略の改善**
  - [ ] 指数バックオフの実装
  - [ ] 最大リトライ回数の動的調整
  - [ ] リトライ時の前処理パラメータ変更

### 5.2 品質評価メトリクスの追加

- [ ] **フレーム品質スコアの実装**
  - [ ] コントラスト評価
  - [ ] シャープネス評価（ラプラシアン分散）
  - [ ] ノイズレベル評価
  - [ ] 品質スコアに基づく処理の分岐
- [ ] **OCR 信頼度の多角的評価**
  - [ ] 各エンジンの信頼度の分散
  - [ ] 文字列の整合性スコア（正規表現マッチ度）
  - [ ] 前後フレームとの一貫性

### 5.3 エッジケースへの対応

- [ ] **特殊条件のハンドリング**
  - [ ] 完全に暗いフレーム（カメラオフ）
  - [ ] タイムスタンプが欠損したフレーム
  - [ ] タイムスタンプ位置が変動するケース
  - [ ] 複数のタイムスタンプが表示されるケース

---

## 🟣 Phase 6: 監視・ロギング

### 6.1 詳細ログの実装

- [ ] **構造化ログの導入**
  - [ ] JSON 形式でのログ出力
  - [ ] ログレベルの適切な設定
  - [ ] 重要メトリクスのログ記録
- [ ] **進捗バーの追加**
  - [ ] `tqdm` による進捗表示
  - [ ] 推定残り時間の表示
  - [ ] 処理済みフレーム数/総フレーム数

### 6.2 モニタリングダッシュボード

- [ ] **リアルタイムメトリクス表示**（オプション）
  - [ ] 処理速度（FPS）
  - [ ] OCR 精度の移動平均
  - [ ] エラー率
  - [ ] メモリ/CPU 使用率

### 6.3 アラート機能

- [ ] **異常検知とアラート**
  - [ ] OCR 精度が閾値を下回った場合
  - [ ] エラー率が高い場合
  - [ ] 処理時間が予想を大幅に超過した場合

---

## 🟤 Phase 7: 本番運用準備

### 7.1 本番データでの全量処理

- [ ] **70 時間動画の完全処理**
  ```bash
  python main.py --mode extract_frames --video input/merged_moviefiles.mov
  ```
  - [ ] 処理時間の記録（目標: 2 時間以内）
  - [ ] メモリピーク値の記録
  - [ ] エラー発生状況の記録
- [ ] **結果の検証**
  - [ ] 期待フレーム数（約 840）との比較
  - [ ] ランダムサンプル 100 フレームの目視確認
  - [ ] 時系列整合性スコアの最終測定

### 7.2 パラメータチューニング

- [ ] **グリッドサーチによる最適化**
  - [ ] 信頼度閾値（0.5, 0.6, 0.7, 0.8）
  - [ ] 粗サンプリング間隔（5 秒, 10 秒, 15 秒）
  - [ ] 探索ウィンドウ（±20 秒, ±30 秒, ±40 秒）
- [ ] **最適パラメータの決定**
  - [ ] 精度とスピードのトレードオフ
  - [ ] `config.yaml` への反映

### 7.3 成果物の整備

- [ ] **出力ファイルの整理**
  - [ ] フレーム画像のフォルダ構成
  - [ ] CSV 結果ファイルの検証
  - [ ] メタデータファイルの生成
- [ ] **バックアップ作成**
  - [ ] 元動画のバックアップ
  - [ ] 抽出結果のバックアップ
  - [ ] 設定ファイルのバージョン管理

---

## 📚 Phase 8: ドキュメント整備

### 8.1 技術ドキュメント

- [ ] **`docs/ARCHITECTURE.md`** 作成
  - [ ] システムアーキテクチャ図
  - [ ] モジュール間の依存関係
  - [ ] データフロー図
- [ ] **`docs/API_REFERENCE.md`** 作成
  - [ ] 各クラス・メソッドのドキュメント
  - [ ] 引数・戻り値の説明
  - [ ] 使用例
- [ ] **`docs/CONFIGURATION.md`** 作成
  - [ ] `config.yaml` の全項目説明
  - [ ] 推奨設定値
  - [ ] トラブルシューティング

### 8.2 運用ドキュメント

- [ ] **`docs/USER_GUIDE.md`** 作成
  - [ ] インストール手順
  - [ ] 基本的な使い方
  - [ ] よくある質問（FAQ）
- [ ] **`docs/OPERATION_MANUAL.md`** 作成
  - [ ] 本番運用手順
  - [ ] トラブルシューティングガイド
  - [ ] エラーコード一覧
- [ ] **`docs/PERFORMANCE_TUNING.md`** 作成
  - [ ] パフォーマンス最適化のヒント
  - [ ] ハードウェア要件
  - [ ] ベンチマーク結果

### 8.3 コードドキュメント

- [ ] **docstring の追加・更新**
  - [ ] すべての公開クラスに docstring
  - [ ] すべての公開メソッドに docstring
  - [ ] Google 形式または NumPy 形式に統一
- [ ] **型ヒントの追加**
  - [ ] すべての関数に型アノテーション
  - [ ] `mypy` による型チェック

---

## 🔧 Phase 9: CI/CD 整備

### 9.1 自動テストの設定

- [ ] **pytest の設定**
  - [ ] `pytest.ini` 作成
  - [ ] カバレッジ測定設定（`pytest-cov`）
  - [ ] テストの自動実行
- [ ] **GitHub Actions 設定**（使用している場合）
  - [ ] `.github/workflows/test.yml` 作成
  - [ ] プッシュ時の自動テスト
  - [ ] カバレッジレポート生成

### 9.2 コード品質チェック

- [ ] **Linter の導入**
  - [ ] `flake8` または `pylint` 設定
  - [ ] `black` によるフォーマット統一
  - [ ] `isort` による import 順序整理
- [ ] **静的解析**
  - [ ] `mypy` による型チェック
  - [ ] `bandit` によるセキュリティチェック

---

## 📊 Phase 10: 最終評価・レポート

### 10.1 定量評価

- [ ] **精度指標の測定**
  - [ ] OCR 精度: 目標 ≥90%
  - [ ] 時系列整合性スコア: 目標 ≥80%
  - [ ] 平均信頼度: 目標 ≥0.7
  - [ ] 目標時刻との誤差: 目標 ≤10 秒
  - [ ] 抽出成功率: 目標 ≥95%
- [ ] **性能指標の測定**
  - [ ] 処理速度: 目標 ≤2 時間
  - [ ] メモリ使用量: 目標 ≤8GB
  - [ ] CPU 使用率: 目標 ≤80%

### 10.2 改善効果の可視化

- [ ] **Before/After 比較**
  - [ ] 旧実装との精度比較グラフ
  - [ ] 処理時間の比較
  - [ ] エラー率の比較
- [ ] **評価レポート作成**
  - [ ] `reports/evaluation_report.md`
  - [ ] グラフ・表を含む
  - [ ] 改善施策の効果分析

### 10.3 成果発表資料

- [ ] **プレゼンテーション資料**
  - [ ] 課題と解決策のサマリー
  - [ ] 実装内容のハイライト
  - [ ] 定量的な改善結果
  - [ ] 今後の展望

---
